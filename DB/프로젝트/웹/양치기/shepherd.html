<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="favicon.png" type="image/png">
		<title>ì–‘ì¹˜ê¸°</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body class="NORMAL showTier showMainTag showSubTag showToc ">
		<header>
			<div class="controls">
				<label>ê²€ìƒ‰:</label><input id="searchInput" type="text" placeholder="...">
				<label>í‹°ì–´:</label><input id="toggleTier" type="checkbox" checked />
				<input id="tierMin" type="number" min="1" max="30" placeholder="ìµœì†Œ" /> ~
				<input id="tierMax" type="number" min="1" max="30" placeholder="ìµœëŒ€" />
				<div id="tierReset">â†©</div>
				<button id="getRandom">ëœë¤</button>
				<label>íƒœê·¸:</label>
				<button id="toggleToc">ëª©ì°¨</button>
				<button id="toggleMainTag">ë©”ì¸</button>
				<button id="toggleSubTag">ì„œë¸Œ</button>
				<label>ë³´ê¸°:</label>
				<button id="toggleSolution">í•´ë‹µ</button>
				<button id="toggleDuple">ì¤‘ë³µ</button>
				<button id="toggleSolved">í•´ê²°</button>
			</div>
			<div id="toc"></div>
		</header>
		<main>
			<div id="deck"></div>		
		</main>

		<script>
			let Q = s => document.querySelector(s);
			let QQ = s => [...document.querySelectorAll(s)];
			let randz = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

			Element.prototype.Q = function(s, ele=this) { return ele.querySelector(s) };
			Element.prototype.QQ = function(s, ele=this) { return ele.querySelectorAll(s) };
			Set.prototype.toggle = function(e, set=this) { set.has(e) ? set.delete(e) : set.add(e) };

			const DB = { problems: [], categories: [] };
			const state = { renderMax: 20, showDuple: false, includeTags: new Set(), excludeTags: new Set(), tierMin: 0, tierMax: 31 };

			function createElement(tag, className, content) {
				const el = document.createElement(tag);
				if (className) el.className = className;
				if (content) el.textContent = content;
				return el;
			}

			function createCategoryElements() {
				container = createElement('div');
				container.id = "toc";

				DB.categories.forEach(({ group, tags }) => {
					[group, ...tags].forEach(tag => {
						const btn = createElement('button', `tag-button`, tag);
						if (tag == group) btn.classList.add('group-button');
						btn.setAttribute('name', tag);
						btn.addEventListener('click', e => {
							e.preventDefault();
							state.includeTags.toggle(tag); 
							state.excludeTags.delete(tag);
							e.target.classList.toggle('include');
							e.target.classList.remove('exclude');
							state.renderMax = 20;
							renderProblems();
						});
						btn.addEventListener('contextmenu', e => {
							e.preventDefault();
							state.excludeTags.toggle(tag);
							state.includeTags.delete(tag);
							e.target.classList.toggle('exclude');
							e.target.classList.remove('include');
							state.renderMax = 20;
							renderProblems();
						});
						container.appendChild(btn);
					});
				});

				return container;
			}

			function createProblemElements() {
				container = createElement('div');
				container.id = "deck";
				state.problemElements = [];

				DB.problems.forEach(problem => {
					const card = createElement('div', 'card');
					card.dataset.id = problem.id;

					const ë³¸ë¬¸1 = createElement('div', 'content');
					const ê¸‰ê°„ = ['', 'ë¸Œë¡ ì¦ˆ', 'ì‹¤ë²„', 'ê³¨ë“œ', 'í”Œë˜', 'ë‹¤ì´ì•„', 'ë£¨ë¹„'][Math.ceil(problem.tier / 5)];
					const í‹°ì–´ = createElement('span', `tier ${ê¸‰ê°„}`, `${ê¸‰ê°„}${5 - (problem.tier - 1) % 5}`);
					const ìš”ì•½ = createElement('a', 'summary', `${problem.summary} `);
					const ìˆ˜ì •1 = createElement('textarea', 'editContent');
					ìš”ì•½.href = 'https://www.acmicpc.net/problem/' + problem.id;
					ìš”ì•½.target = "_blank";
					ìš”ì•½.rel = "noopener noreferrer"; 
					ë³¸ë¬¸1.append(í‹°ì–´);
					ë³¸ë¬¸1.append(ìš”ì•½);
					ë³¸ë¬¸1.append(ìˆ˜ì •1);
					card.append(ë³¸ë¬¸1);
					
					const ë³¸ë¬¸2 = createElement('div', 'solution');
					const êµ¬ë¶„ì„  = createElement('hr');
					const í•´ë‹µ = createElement('p', 'code', problem.solution1 || '');
					const ìˆ˜ì •2 = createElement('textarea', 'editSolution');
					ë³¸ë¬¸2.append(êµ¬ë¶„ì„ );
					ë³¸ë¬¸2.append(í•´ë‹µ);
					ë³¸ë¬¸2.append(ìˆ˜ì •2);
					card.append(ë³¸ë¬¸2);
					
					const íƒœê·¸ë°•ìŠ¤ = createElement('div', 'tagbox');
					const ì €ì¥ = createElement('span', 'editSave', 'ğŸ’¾');
					const ì·¨ì†Œ = createElement('span', 'editCancel', 'âŒ');
					const í¸ì§‘ = createElement('span', 'editCard', 'ğŸ“');
					const ë‹µë³´ê¸° = createElement('span', 'viewSolved', 'ğŸ‘€');
					const ì£¼íƒœê·¸ = problem.tags.filter(t =>  t.endsWith('!')).map(t => t.slice(0, -1));
					const ë¶€íƒœê·¸ = problem.tags.filter(t => !t.endsWith('!'));
					íƒœê·¸ë°•ìŠ¤.append(ì €ì¥);
					íƒœê·¸ë°•ìŠ¤.append(ì·¨ì†Œ);
					íƒœê·¸ë°•ìŠ¤.append(í¸ì§‘);
					íƒœê·¸ë°•ìŠ¤.append(ë‹µë³´ê¸°);
					íƒœê·¸ë°•ìŠ¤.append( ...ì£¼íƒœê·¸.map(tag => createElement('span', 'tag main-tag', `#${tag}`)) );
					íƒœê·¸ë°•ìŠ¤.append( ...ë¶€íƒœê·¸.map(tag => createElement('span', 'tag sub-tag', `#${tag}`)) );

					if (!problem.tags[0]) íƒœê·¸ë°•ìŠ¤.append(createElement('span', 'tag sub-tag', '#ë¯¸ë¶„ë¥˜'));
					card.append(íƒœê·¸ë°•ìŠ¤);

					if (problem.dup) card.classList.add('dup');

					container.appendChild(card);
					state.problemElements.push({ element: card, problem });
				});
				container.appendChild( createElement('div', 'card create', 'ì¶”ê°€') );
				container.appendChild( createElement('div', 'card more', 'ë” ë³´ê¸°') );

				return container;
			}

			function renderProblems() {
				QQ('.card.draw').forEach(prev => prev.classList.remove('draw'));

				const ê²€ìƒ‰ì–´ = Q('#searchInput').value.toLowerCase();
				const ìµœëŒ€í‹°ì–´ = Q('#tierMax').value*1||30;
				const ìµœì†Œí‹°ì–´ = Q('#tierMin').value*1||1;
				state.randomAble = [];

				state.valid = 0;
				rendered = 0;
				state.problemElements.forEach(({ element: ì¹´ë“œ, problem: ë¬¸ì œ }) => {
					const íƒœê·¸ì›ë³¸ = ë¬¸ì œ.tags.map(t => t.replace('!', ''));
					const ë¬¸ì œíƒœê·¸ = íƒœê·¸ì›ë³¸.length ? íƒœê·¸ì›ë³¸ : ['ë¯¸ë¶„ë¥˜'];

					const ì¤‘ë³µí™•ì¸ = (!ë¬¸ì œ.dup || state.showDuple);
					const í‹°ì–´ì¼ì¹˜ = ìµœì†Œí‹°ì–´ <= ë¬¸ì œ.tier && ë¬¸ì œ.tier <= ìµœëŒ€í‹°ì–´;
					const íƒœê·¸í¬í•¨ = [...state.includeTags].every(tag => ë¬¸ì œíƒœê·¸.includes(tag));
					const íƒœê·¸ì œì™¸ = [...state.excludeTags].some(tag => ë¬¸ì œíƒœê·¸.includes(tag));
					const ê²€ìƒ‰ì¼ì¹˜ = ë¬¸ì œ.summary.includes(ê²€ìƒ‰ì–´) || ë¬¸ì œíƒœê·¸.some(tag => tag.includes(ê²€ìƒ‰ì–´));

					const ì¡°ê±´ë§Œì¡± = ì¤‘ë³µí™•ì¸ && í‹°ì–´ì¼ì¹˜ && íƒœê·¸í¬í•¨ && !íƒœê·¸ì œì™¸ && ê²€ìƒ‰ì¼ì¹˜;
					const ëœë¤ì¡°ê±´ = ì¤‘ë³µí™•ì¸ && í‹°ì–´ì¼ì¹˜;

					if (ì¡°ê±´ë§Œì¡±) state.valid++;
					if (ì¡°ê±´ë§Œì¡± && rendered < state.renderMax) { ì¹´ë“œ.classList.add('draw'); rendered++; }
					if (ëœë¤ì¡°ê±´) state.randomAble.push(ì¹´ë“œ);
				});
				
				state.remain = rendered < state.valid;
				if (state.remain) Q('.card.more').innerText = `ë” ë³´ê¸° (${rendered}/${state.valid})`;
				else {Q('.card.more').innerText = `ì´ ${rendered}ë¬¸ì œ`;}
			}

			function randomDefence() {
				QQ('.random').forEach(prev => prev.classList.remove('random'));
				renderProblems();
				
				const ëœë¤í›„ë³´ = state.randomAble;
				[...Array(2)].map(_ => {
					ì¹´ë“œ = ëœë¤í›„ë³´[randz(0, ëœë¤í›„ë³´.length - 1)];
					ì¹´ë“œ.classList.add('random');
				});
			}
			
			function editCard(card) {
				const ìˆ˜ì •ì¹´ë“œ = card;
				const ë¬¸ì œì •ë³´ = DB.problems.find(p => p.id == ìˆ˜ì •ì¹´ë“œ.dataset.id);
				ìˆ˜ì •ì¹´ë“œ.classList.add('edit');

				ìˆ˜ì •ì¹´ë“œ.Q('.editContent').value = ë¬¸ì œì •ë³´.summary;
				ìˆ˜ì •ì¹´ë“œ.Q('.editSolution').value = ë¬¸ì œì •ë³´.solution1;
			}
	
			function editSave(card) {
				const ìˆ˜ì •ì¹´ë“œ = card;
				const ë¬¸ì œì •ë³´ = DB.problems.find(p => p.id == ìˆ˜ì •ì¹´ë“œ.dataset.id);

				console.log( ìˆ˜ì •ì¹´ë“œ.Q('.editContent'), ìˆ˜ì •ì¹´ë“œ.Q('.editContent').value );

				ìˆ˜ì •ì¹´ë“œ.Q('.summary').innerText = ìˆ˜ì •ì¹´ë“œ.Q('.editContent').value;
				ìˆ˜ì •ì¹´ë“œ.Q('.code').innerText = ìˆ˜ì •ì¹´ë“œ.Q('.editSolution').value;
				ìˆ˜ì •ì¹´ë“œ.classList.remove('edit');
			}

			document.addEventListener('DOMContentLoaded', async () => {
				const problems = await fetch('./problems.json').then(r => r.json());
				const categories = await fetch('./categories.json').then(r => r.json());
				DB.problems = problems;
				DB.categories = categories;
				Q('#toc').replaceWith( createCategoryElements() );
				Q('#deck').replaceWith( createProblemElements() );
				randomDefence();

				Q('#searchInput').addEventListener('input', renderProblems);

				Q('#tierMin').addEventListener('input', renderProblems);
				Q('#tierMax').addEventListener('input', renderProblems);
				Q('#tierReset').addEventListener('click', _ => {Q('#tierMin').value = Q('#tierMax').value = ''; renderProblems()} );

				Q('#getRandom').addEventListener('click', randomDefence);

				Q('#toggleTier').addEventListener('change', e => Q('body').classList.toggle('showTier'));
				Q('#toggleMainTag').addEventListener('click', e => Q('body').classList.toggle('showMainTag'));
				Q('#toggleSubTag').addEventListener('click', e => Q('body').classList.toggle('showSubTag'));
				Q('#toggleToc').addEventListener('click', e => Q('body').classList.toggle('showToc'));
				Q('#toggleSolution').addEventListener('click', e => Q('body').classList.toggle('showSolution'));
				Q('#toggleDuple').addEventListener('click', e => { Q('body').classList.toggle('showDuple'); state.showDuple = !state.showDuple; renderProblems(); });

				Q('.more').addEventListener('click', e => { if(state.remain) {state.renderMax += 20; renderProblems();} });

				QQ('.tag').forEach(tag => tag.onclick = e=>Q(`[name=${tag.innerText.slice(1)}]`).click() );
				QQ('.viewSolved').forEach(eye => eye.onclick = e=>e.target.closest('.card').classList.toggle('showSolution') );

				QQ('.editCard').forEach(edit => edit.onclick = e=> editCard(e.target.closest('.card')) );
				QQ('.editSave').forEach(disc => disc.onclick = e=> editSave(e.target.closest('.card')) );
				QQ('.editCancel').forEach(X => X.onclick = e=>e.target.closest('.card').classList.remove('edit') );
			});

		</script>
	</body>
</html>
