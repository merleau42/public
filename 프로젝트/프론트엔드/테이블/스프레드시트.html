<html>
<head>
	<style>
		body {
			margin: 0;
			font-family: Arial, Helvetica, sans-serif;
			background-color: inherit !important;
		}
		.slot {
			margin: auto;
			margin-top: 30;
			min-height: 10%;
			text-align: center;
		}
		.container
		{
			margin-top: -30px;
			height: 30px;
			width: 100%;
			position: fixed;
			background-color: ghostwhite;
			opacity: 70%;
			text-align: center;
		}
		#Search, #Clear, #Total, #Bin, #Refresh, #Save, #Load
		{
			display: inline-block;
			text-align: center;
			font-size: large;
			background: 0;
		}
		#Search
		{
			width: 40%;
		}
		#Clear
		{
			opacity: 60%;
		}
		#Bin, #Refresh, #Save, #Load
		{
			padding-left: 3;
			padding-right: 0;
			border: 0;
			cursor: pointer;
		}
		#Bin
		{
			color: red;
		}
		#Refresh
		{
			color: darkgreen;
			font-size: small;
			font-weight: bold;
			opacity: 80%;
		}
		#Total
		{
			opacity: 80%;
		}
		table {
			max-height: 0;
			height: 100%;
			width: 100%;
			border: 1;
			border-collapse: collapse;
		}
		th, td {
			padding: 2px;
			font-size: 15;
		}
		.Cell {
			height: 100%;
			width: 100%;
			border: 0;
			text-align: center;
			background-color: inherit;
		}
		.P0 {background-color: rgb(192, 192, 192);}
		.P1 {background-color: rgb(255, 192, 0);}
		.P2 {background-color: rgb(255, 255, 0);}
		.P3 {background-color: rgb(255, 255, 170);}
		.P4 {background-color: rgb(0, 204, 0);}
		.P5 {background-color: rgb(0, 255, 0);}
		.P6 {background-color: rgb(187, 255, 187);}
		.P7 {background-color: rgb(255, 136, 255);}
		.P8 {background-color: rgb(136, 136, 255);}
		.P9 {background-color: rgb(192, 192, 255);}
		.index, .roof, .edge {
			background-color: rgb(210, 210, 210);
		}
		.mousedown, .dragging {
			background-color: rgb(160, 160, 160);
		}
		.index:hover:not(.mousedown, [class*=Rclick]) {
			background-color: rgb(230, 230, 230);
		}
		tr.dropable {
			border-top: 3px dotted;
			background-color: rgb(240, 240, 240);
		}
		td.dropable {
			border-left: 3px dotted;
			background-color: rgb(240, 240, 240);
		}
		.index {
			width: 5vw;
			text-align: center;
		}
		.index.Rclick_, .roof.Rclick_ {
			background: coral;
		}
		.index.Rclick__, .roof.Rclick__ {
			background: crimson;
		}
		tr:has(.index.Rclick__) td:not(.index){
			background: coral;
		}
		.floating {
			content: '‚ûï';
		}
		.debug {
			border-bottom: 1px dotted;
			/* border-right: 1px dotted; */
			border-left: 1px dotted;
			/* display: inline-flex; */
			display: inline-table;
			font-size: 13px;
		}
	</style>
	<script>
		let xhttp = new XMLHttpRequest();
		let bugs = ['üêå','ü¶ã','üêõ','üêú','üêù','ü™≤','üêû','ü¶ó','ü™≥','ü¶ü','ü™∞','ü™±'];
		let files = {};
		let vecs = {};
		let tabs = {};
		let html = document.querySelector('html');
		let head = document.querySelector('head');
		let body = document.querySelector('body');
		let E = x => document.createElement(x);
		let dummy = E('dummy');
		let Q = (x, y=document) => y.querySelector(x);
		let QQ = (x, y=document) => [...y.querySelectorAll(x)];
		function leak(className='')
		{
			if (!className)
				return QQ('[class]').reduce((s,c)=>[...s, [...c.classList].filter(x=>!s.includes(x))].flat(), []).toSorted();
			else
				return QQ(`[class*=${className}]`)
		}
		function load_file(fd, path)
		{
			xhttp.open("GET", path, false);
			xhttp.send();
			if (xhttp.readyState == 4 && xhttp.status == 200)
				files[fd] = xhttp.response;
		}
		function swap_key_value(map)
		{
			return JSON.parse(`{${keys(map).map(x=>`"${map[x]}":"${x}"`).join(',')}}`);
		}
		function parse(category, keyword)
		{
			parsed = {};
			category = `\x00${category}\x7F`;
			keyword = `\x00${keyword}\x7F`;

			[...category]
			.map((x,i,a) => [keyword.indexOf(x), x])
			.toSorted((x,y) => x[0] - y[0])
			.forEach((x,i,a) =>{
				if (i < a.length - 1) parsed[a[i][1]] = keyword.substring(a[i][0] + 1, a[i+1][0])
			});

			return parsed;
		}
		function debug(channel, curtain, msg, ...argvs)
		{
			if (!Q(`.debug[channel='${channel}']`))
			{
				div = Q('body').appendChild(E('div'))
				div.classList.add('debug');
				div.setAttribute('channel', channel);
				div.setAttribute('icon', bugs[Math.round(Math.random() * 9999) % 12]);
				div.innerText = `Debug ${channel}\n`;
				red = Math.round(Math.random() * 0x50 + 0x30).toString(16);
				grn = Math.round(Math.random() * 0x50 + 0x30).toString(16);
				blu = Math.round(Math.random() * 0x50 + 0x30).toString(16);
				div.style.color = `#${red}${grn}${blu}`;
			}
			dbg = Q(`.debug[channel='${channel}']`);
			// Î∞òÏùëÌòï Í∞ÄÎ°ú Í∏∏Ïù¥
			// QQ('.debug').forEach(x => x.style.width='');
			// QQ('.debug')
			// .map((x,i,db) => Math.floor( 10000000 * x.offsetWidth / body.offsetWidth) )
			// .map((x,i,arr)=> Math.floor( 100 * x / arr.reduce((s,c)=>s+c)) - 1 + '%' )
			// .forEach((x,i) => QQ('.debug')[i].style.width = x)
			if (typeof(msg) == typeof(Object()))
				if (attrs = msg.getAttributeNames().toSorted()
							   .map(attr=>` [${attr}:=${msg.getAttribute(attr).split(' ').join(', ')}]`))
					msg = `${msg.tagName}, ${attrs}${msg.value ? `, [value=${msg.value}]` : ''}`;
			tail = `${dbg.getAttribute('icon')}${msg}${argvs.length ? `, ${argvs}` : ''}`;
			spl = dbg.innerText.replace(/\n$/,'').split('\n');
			if (spl.length >= 13)
			{
				if (curtain)
					spl = [spl[0]];
				else
					spl = [spl[0], ...spl.splice(2)];
			}
			spl.push(tail);
			dbg.innerText = spl.join('\n');
		}
		function free_class(classNames, wildcard=false)
		{
			if (wildcard)
				classNames.forEach(cn => QQ(`[class*=${cn}]`).forEach(el =>
					[...el.classList].forEach(c => {if(c.includes(cn)) el.classList.remove(c)})))
			else
				classNames.forEach(cn => QQ(`.${cn}`).forEach(el => el.classList.remove(cn)));
		}
	</script>
	<script>
		let category = "@#$%^&*";
		let alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
		window.addEventListener('DOMContentLoaded',	main)
		function main()
		{
			body = document.body;
			load_file(1, 'Ï†ÄÏû•.json');
			vecs[1] = map_to_vec( JSON.parse( files[1] ) );
			tabs[1] = vec_to_table( vecs[1], 1 );
			slot1.innerText = '';
			slot1.appendChild(tabs[1]);

			load_file(2, 'Ï†ÄÏû•.txt')
			vecs[2] = (files[2].split('\n').map(x=>x.split(',')));
			tabs[2] = vec_to_table( vecs[2], 2 );
			slot2.innerText = '';
			slot2.appendChild( tabs[2] );

			mouse_listner();
			setInterval(monitor, 300);
		}
		function monitor()
		{
			debug(1, false, [leak().length, leak().join(' ')].join(': '));
			debug(2, false, '213213');
		}
		function mouse_listner()
		{
			document.addEventListener('dblclick', e => {
				e.target.classList.add('dblclick')
				table = Q('table:has(.dblclick)');
				if (Q('.index.dblclick')) {
					newr = vec_to_table( [[], QQ('th', table).map(x=>'')] ).querySelector('tbody tr');
					move_table_row( newr, Q('tr:has(.dblclick.index)') );
				}
				free_class(['dblclick']);
			})
			document.addEventListener('contextmenu', e => {
				event.preventDefault(); // Í∏∞Î≥∏ Ïò§Î•∏Ï™Ω ÌÅ¥Î¶≠ Î©îÎâ¥ ÏïàÎú®ÎèÑÎ°ù.
				if (!e.target.className.match('Rclick')){
					free_class(['Rclick'], wildcard = true);
					e.target.classList.add('Rclick_');
				}
				else
					e.target.className = e.target.className.replace(/Rclick(_*)/, 'Rclick$1_');
				if (Q('.Rclick___.index'))
				{
					Q('tr:has(.Rclick___.index)').remove();
					refresh_table_index();
				}
			})
			document.addEventListener('mousedown', e => {
				e.target.classList.add('mousedown');
				if ([...e.target.classList].filter(cn=>cn.includes('Rclick')).length == 0)
					free_class(['Rclick'], wildcard = true);
				if (Q('.mousedown.index'))
					Q('tr:has(.mousedown.index)').classList.add('dropable');
				if (Q('.mousedown.roof')){
					col_line = Q('.mousedown.roof').getAttribute('col');
					QQ(`table:has(.mousedown.roof) [col="${col_line}"]`).forEach(td => td.classList.add('dropable'));
				}
			})
			document.addEventListener('dragstart', e => {
				free_class(['Rclick'], wildcard = true);
				e.target.classList.add('dragging');
			})
			document.addEventListener('dragend', e => {
				free_class(['enter','dropable','dragging','to_drop','mousedown'])
			})
			document.addEventListener('dragover', e => { // 'over' ÏûàÏñ¥Ïïº 'drop' Í∞ÄÎä•
				e.preventDefault();
			})
			document.addEventListener('dragenter', e => { // 'over' ÏûàÏñ¥Ïïº 'drop' Í∞ÄÎä•
				debug(2, true, e.target);
				free_class(['enter', 'dropable']);
				e.target.classList.add('enter');
				if (Q('.dragging.index'))
					Q('tr:has(.enter)').classList.add('dropable');
				if (Q('.dragging.roof')){
					col_line = Q('td.enter, td:has(.enter)').getAttribute('col');
					QQ(`table:has(.dragging.roof) [col="${col_line}"]`).forEach(td => td.classList.add('dropable'));
				}
			})
			document.addEventListener('drop', e => {
				e.target.classList.add('to_drop')
				if (Q('.dragging.index') && Q('tbody tr:has(.to_drop)'))
					move_table_row(Q('.dragging').parentNode, Q('tbody tr:has(.to_drop)'));
			})
			document.addEventListener('mouseup', e => {
				free_class(['dropable','mousedown','dblclick']);
			})
		}
		// ÌÖåÏù¥Î∏î <==> Î≤°ÌÑ∞ <==> Îßµ
		function vec_to_table(arr, fd=null)
		{
			table = document.createElement('table');
			thead = document.createElement('thead');
			tbody = document.createElement('tbody');
			arr.forEach((row, i) => {
				tr = document.createElement('tr');
				row.forEach((col, j) => {
					parsed = parse('„Ö∑', col);
					td = i > 0 ? document.createElement('td') : document.createElement('th');
					if (i > 0 && j > 0){
						input = document.createElement('input');
						input.classList.add( "Cell" );
						input.value = parsed['\x00'];
						td.appendChild(input);
						if (parsed['„Ö∑']) td.classList.add (parsed['„Ö∑']);
					}
					else if (i != 0 && j == 0){
						td.classList.add ("index");
						td.innerText = i
					}
					else if (i == 0 && j != 0){
						td.classList.add ("roof");
						td.innerText = j < 8 ? category[j - 1] : ''
						td.innerText += `${alpha[Math.floor((j-27)/26)]??""}${alpha[(j-1)%26]}`;
					}
					else if (i == 0 && j == 0)
						td.classList.add ("edge");
					// td.setAttribute('row', i);
					td.setAttribute('col', j);
					td.setAttribute("draggable", true)
					tr.appendChild(td);
					tr.setAttribute('row', i);
				})
				i > 0 ? tbody.appendChild(tr) : thead.appendChild(tr)
			})
			table.appendChild(thead);
			table.appendChild(tbody);
			table.border = 1;
			if (fd) table.id = `table${fd}`;
			return table;
		}
		function table_to_vec(table)
		{
			return [...table.querySelectorAll('tr')].map((tr,i) => {
				return [...tr.querySelectorAll('th, td')].map((td,j) => {
					if (i==0 || j==0)
						return '';
					text = td.querySelector('.Cell').value;
					bg = [...td.classList].filter(x=>x[0]=='P')[0];
					bg = bg ? `„Ö∑${bg}` : ''
					return text + bg;
				})
			})
		}
		// map['Ìñâ,Ïó¥'] = 'ÏÖÄÏ†ïÎ≥¥' <===> vec[Ìñâ][Ïó¥] = 'ÏÖÄÏ†ïÎ≥¥'
		function vec_to_map(arr, map={})
		{
			arr.forEach((row,i) => {
				row.forEach((col,j) => {
					if (col)
						map[`${i},${j}`] = col;
				})
			});
			return map;
		}
		function map_to_vec(map)
		{
			points = Object.keys(map).map(x=>x.split(',').map(e=>e*1))
			max_row = points.toSorted((a,b)=>b[0] - a[0])[0][0] + 1;
			max_col = points.toSorted((a,b)=>b[1] - a[1])[0][1] + 1;
			arr = Array.from({length:max_row}, x => Array.from({length:max_col}))
			arr.forEach((row,i)=>{
				row.forEach((col,j)=>{
					arr[i][j] = map[`${i},${j}`]??'';
				})
			});
			return arr;
		}
		function table_to_map(table, map={})
		{
			return vec_to_map(table_to_vec(table), map);
		}
		function map_to_table(map, fd=null)
		{
			return vec_to_table(map_to_vec(map), fd);
		}
		function move_table_row(tr1, tr2)
		{
			if (tr1.rowIndex > tr2.rowIndex)
				tr2.before(tr1);
			else if (tr1.rowIndex < tr2.rowIndex)
				tr2.after(tr1);
			refresh_table_index();
		}
		function refresh_table_index()
		{
			[...document.querySelectorAll('tbody tr')].forEach(tr => {
				tr.setAttribute('row', tr.rowIndex);
				tr.querySelector('.index').innerText = tr.rowIndex;
			})
		}
		// exam.map(x=>x.toSpliced(2,0,'added')) // Ïó¥ Ï∂îÍ∞Ä
		// exam.toSpliced(2,0,['added']) // Ìñâ Ï∂îÍ∞Ä
	</script>
</head>
<body>
<div class="container">
<input id="Search" type="text" placeholder="Í≤ÄÏÉâÏñ¥ (ÌïÑÎìúÏóêÏÑú Ï∞æÍ∏∞: @#$%^&)"><input id="Clear" type="button" value="X">
<div id="Total"></div><a download="80000.json"><input id="Save" type="button" value="üíæ"></a><input id="Load" type="button" value="üìÇ"><input id="Bin" type="button" value="üóë"><input id="Refresh" type="button" value="ÏÉàÎ°úÍ≥†Ïπ®">
</div>
<div class="slot" id="slot1">1</div>
<div class="slot" id="slot2">2</div>
</body>
</html>