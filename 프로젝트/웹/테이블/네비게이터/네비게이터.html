<!DOCTYPE html>
<html data-server-no-reload>
	<head>
		<title>CSV 데이터를 HTML 표로 불러오기</title>
		<style>
			th {
				cursor: pointer;
				text-align: center;
			}
	
			th.sorted-asc::after {
				content: "▲";
			}
	
			th.sorted-desc::after {
				content: "▼";
			}
	
			th, td {
				font-family: Malgun Gothic;
				border: 1px solid #909090;
				min-width: 42px;
			}

			table, iframe, .nav-container, .wrap {
				width: 98%;
				margin: 0 auto; /* 가운데 정렬 */
				border-collapse: collapse;
				margin-bottom: 25px; /* 조금 띄우기 */
				border: 1px solid #909090;
				background-color: #2f2f2f;
			}

			#iframeSheets {
				width: 100%;
				height: 650px;
				border: none;
			}

			#floatingContainer{
				top: 0;
				right: 10px;
				height: 30px;
				position: fixed;
				bottom: 10px;
				font-size: 20px;
				border: none;
				z-index: 999; /* 다른 요소 위로 표시하기 위해 높은 값 설정 */
				background: none;
			}

			select {
				background-color: #2f2f2f;
				color: #dddddd;
			}
			
			#floatingToggleButton {
				display: inline;
				cursor: pointer;
				background: none;
			}

			body {
				font-size: 14px;
				background-color: #1f1f1f;
				color: #dddddd;
			}
		</style>

	</head>
	
<body data-server-no-reload>
	<div class="nav-container">
		<div class="nav-content">
			<span>태그　</span>
			<select id="includeTagDropdown1">
				<option value="">포함</option>
			</select><select id="includeTagDropdown2">
				<option value="">포함</option>
			</select><select id="excludeTagDropdown1">
				<option value="">미포함</option>
			</select><select id="excludeTagDropdown2">
				<option value="">미포함</option>
			</select>
		</div>
		<div class="nav-content">
			<span>티어　</span>
			<select id="tierAboveDropdown">
				<option value="">이상</option>
			</select><select id="tierBelowDropdown">
				<option value="">이하</option>
			</select><label for="hideForeignLanguage">　외국어</label>
			<input type="checkbox" id="hideForeignLanguage">
			<label for="hideSolved">해결</label>
			<input type="checkbox" id="hideSolved">
		</div>
		<div class="nav-content">
			<span>갱신　</span>
			<select id="refreshDropdown">
				<option value="선택">선택</option>
				<option value="조건대로">조건대로</option>
				<option value="랜덤디펜스">랜덤디펜스</option>
				<option value="초기화">초기화</option>
			</select>
		</div>
	</div>
	<div id="floatingContainer">
		<div id="floatingToggleButton" onclick="toggleNav()">🍴</div><div id="floatingToggleButton" onclick="toggleTable()">📋</div><div id="floatingToggleButton" onclick="toggleProblem()">✍</div>
	</div>
	<table id="csvTable">
		<thead>
		</thead>
		<tbody>
		</tbody>
	</table>
	<iframe id="csvIframe" style="display: none;" src="./BOJ/백준리스트.html"></iframe>
	<iframe id="iframeProblem" src="about:blank"></iframe>
	<div class="wrap">
	<!-- <iframe id="iframeSheets" src="https://docs.google.com/spreadsheets/d/1WH14u8czYA1ZbHr19dW1A87Z_s2caSTllW3pAJMC1wk/edit?usp=sharing"></iframe> -->
	<iframe id="iframeSheets" src="https://docs.google.com/spreadsheets/d/10KYXhngdToXxLSJ1VZAXc5w31mSV-Vs3oZ2soVSt27A"></iframe>
	
	</div>
	<script>
		function toggleNav() {
			const navContainer = document.querySelector('.nav-container');
			navContainer.style.display = navContainer.style.display=='none' ? 'block' : 'none';
		}
		function toggleTable() {
			const csvTable= document.querySelector('#csvTable');
			csvTable.style.display = csvTable.style.display=='none' ? 'table' : 'none';
		}
		const iframe = document.getElementById("csvIframe");
		iframe.addEventListener("load", once);
		function once() {
			iframe.removeEventListener("load", once);
			const csvData = iframe.contentDocument.body.textContent;
			const table = document.getElementById("csvTable");
			const includeTagDropdown1 = document.getElementById("includeTagDropdown1");
			const includeTagDropdown2 = document.getElementById("includeTagDropdown2");
			const excludeTagDropdown1 = document.getElementById("excludeTagDropdown1");
			const excludeTagDropdown2 = document.getElementById("excludeTagDropdown2");
			const tierAboveDropdown = document.getElementById("tierAboveDropdown");
			const tierBelowDropdown = document.getElementById("tierBelowDropdown");
			const refreshDropdown = document.getElementById("refreshDropdown");
			const hideForeignLanguageCheckbox = document.getElementById("hideForeignLanguage");
			const hideSolvedCheckbox = document.getElementById("hideSolved");
			
			const tiers='브실골플다루';
			const tiersColor=["saddlebrown","white","gold","lime","blue","red"];
			// 티어 이상 및 이하 드롭다운에 1부터 30까지의 자연수를 반복문으로 추가
			for (let i = 1; i <= 30; i++) {
				const option = document.createElement("option");
				option.value = i.toString();
				option.textContent = tiers[Math.floor((i-1)/5)]+(5-(i-1)%5+"");
				tierAboveDropdown.appendChild(option);
				tierBelowDropdown.appendChild(option.cloneNode(true));
			}

			// 드롭다운 옵션 채우기
			const uniqueTags = [...new Set(csvData.split("\n").map(row => row.split(",")[2].split('/')).flat())]
			uniqueTags.forEach(tag => {
				if (tag == '태그')
					return;
				const option = document.createElement("option");
				option.value = tag;
				option.textContent = tag;
				includeTagDropdown1.appendChild(option);
				includeTagDropdown2.appendChild(option.cloneNode(true));
				excludeTagDropdown1.appendChild(option.cloneNode(true));
				excludeTagDropdown2.appendChild(option.cloneNode(true));
			});

			// 머리글 행 생성
			const headerRow = document.createElement("tr");
			const headers = csvData.split("\n")[0].split(",");
			headers.forEach(headerText => {
				const th = document.createElement("th");
				th.textContent = headerText;
				th.addEventListener("click", () => sortTable(headers.indexOf(headerText)));
				if (headerText == '외국어' || headerText == '해결')
					th.style.display="none";
				headerRow.appendChild(th);
			});
			table.querySelector("thead").appendChild(headerRow);
			
			// 나머지 줄을 테이블 본문에 추가
			csvData.split("\n").slice(1).forEach(row => {
				const rowData = row.split(",");
				if (rowData.length > 1) {
					const newRow = document.createElement("tr");
					for (let j = 0; j < rowData.length; j++) {
						const cellValue = rowData[j];
						const cell = createCell(cellValue, j, newRow);
						newRow.appendChild(cell);
					}
					table.querySelector("tbody").appendChild(newRow);
				}
			});

			function createCell(value, columnIndex, tr) {
				const td = document.createElement("td");
				td.textContent = value
				if (columnIndex === 0){
					td.addEventListener("click",()=>{
						console.log(value);
						changeIframeSource(value);
					});
				}

				if (columnIndex === 3){
					td.style.color = tiersColor[Math.floor((value-1)/5)];
				}

				if (columnIndex === 4){
					td.textContent = Math.round(value/100)/10 + 'k';
				}
				if (columnIndex === 6){
					if (td.textContent == 1){
						tr.style.color='gray';
					}
					td.style.display="none";
				}
				if (columnIndex === 7){
					if (td.textContent == 1){
						tr.style.color="#4c7d4c";
					}
					td.style.display="none";
				}
				if (columnIndex != 1 && columnIndex != 2){
					td.style.textAlign = "center";
				}
				return td;
			};

			let sortingColumn = -1;
			let ascending = true;
			
			function sortTable(columnIndex) {
				const tbody = table.querySelector("tbody");
				const rows = Array.from(tbody.rows);

				if (sortingColumn === columnIndex) {
					ascending = !ascending;
				} else {
					ascending = true;
					sortingColumn = columnIndex;
				}

				// 머리글 셀에 정렬 아이콘을 추가
				const th = table.querySelector("thead").querySelectorAll("th");
				th.forEach((header, index) => {
					header.classList.remove("sorted-asc", "sorted-desc");
					if (index === columnIndex)
						header.classList.add(ascending ? "sorted-asc" : "sorted-desc");
				});

				rows.sort((a, b) => {
					var cellA = a.cells[columnIndex].textContent.trim();
					var cellB = b.cells[columnIndex].textContent.trim();
					
					if (ascending)
						return cellA.localeCompare(cellB, undefined, { numeric: true, sensitivity: 'base' });
					else
						return cellB.localeCompare(cellA, undefined, { numeric: true, sensitivity: 'base' });
				});
				// 행을 정렬된 순서로 다시 삽입
				for (const row of rows) {
					tbody.appendChild(row);
				}
			}

			// 드롭다운 변경 시 필터링 적용
			includeTagDropdown1.addEventListener("change", () => filterTable());
			includeTagDropdown2.addEventListener("change", () => filterTable());
			excludeTagDropdown1.addEventListener("change", () => filterTable());
			excludeTagDropdown2.addEventListener("change", () => filterTable());
			tierAboveDropdown.addEventListener("change", () => filterTable());
			tierBelowDropdown.addEventListener("change", () => filterTable());
			refreshDropdown.addEventListener("change", () => {
				refreshTable();
				refreshDropdown.selectedIndex = 0; // 기본 옵션으로 리셋
			});
			hideForeignLanguageCheckbox.addEventListener("change", () => filterTable());
			hideSolvedCheckbox.addEventListener("change", () => filterTable());
			
			function filterTable() {
				const selectedIncludeTag1 = includeTagDropdown1.value;
				const selectedIncludeTag2 = includeTagDropdown2.value;
				const selectedExcludeTag1 = excludeTagDropdown1.value;
				const selectedExcludeTag2 = excludeTagDropdown2.value;
				const selectedTierAbove = tierAboveDropdown.value;
				const selectedTierBelow = tierBelowDropdown.value;
				const hideForeignLanguage = hideForeignLanguageCheckbox.checked;
				const hideSolved = hideSolvedCheckbox.checked;
				
				const tbody = table.querySelector("tbody");
				const rows = Array.from(tbody.rows);

				rows.forEach(row => {
					const rowData = row.cells[2].textContent;
					const tierData = parseInt(row.cells[3].textContent);
					const hasForeignLanguage = row.cells[6].textContent === "1";
					const isSolved = row.cells[7].textContent === "1";
					const tags = rowData.split('/');
					const includeTag1Match = !selectedIncludeTag1 || tags.includes(selectedIncludeTag1);
					const includeTag2Match = !selectedIncludeTag2 || tags.includes(selectedIncludeTag2);
					const excludeTag1Match = !selectedExcludeTag1 || !tags.includes(selectedExcludeTag1);
					const excludeTag2Match = !selectedExcludeTag2 || !tags.includes(selectedExcludeTag2);
					const tierMatch = (!selectedTierAbove || tierData >= parseInt(selectedTierAbove)) && (!selectedTierBelow || tierData <= parseInt(selectedTierBelow));

					const showRow = includeTag1Match && includeTag2Match &&
					excludeTag1Match && excludeTag2Match &&
					tierMatch &&
					(hideForeignLanguage || !hasForeignLanguage) && (hideSolved || !isSolved);

					row.style.display = showRow ? "table-row" : "none";
				});
			}

			function refreshTable() {
				// 새로 고침 드롭다운에서 선택된 옵션을 확인
				const refreshOption = refreshDropdown.value;

				if (refreshOption === "조건대로") {
					// 조건에 따라 필터링
					filterTable();
				} else if (refreshOption === "랜덤디펜스") {
					// 랜덤 필터링 예제: 필터된 데이터 중에서 랜덤으로 3개 표시
					filterTable();
					const filteredRows = Array.from(table.querySelector("tbody").rows).filter(row => row.style.display === "table-row");
					const randomIndices = generateRandomIndices(filteredRows.length, 3);
					filteredRows.forEach((row, index) => {
						row.style.display = randomIndices.includes(index) ? "table-row" : "none";
					});
				} else if (refreshOption === "초기화") {
					// 모든 행을 초기화
					Array.from(table.querySelector("tbody").rows).forEach(row => {
						row.style.display = "table-row";
					});

					// 모든 드롭다운을 리셋
					includeTagDropdown1.selectedIndex = 0;
					includeTagDropdown2.selectedIndex = 0;
					excludeTagDropdown1.selectedIndex = 0;
					excludeTagDropdown2.selectedIndex = 0;
					tierAboveDropdown.selectedIndex = 0;
					tierBelowDropdown.selectedIndex = 0;
					refreshDropdown.selectedIndex = 0;

					// 모든 체크박스를 리셋
					hideForeignLanguageCheckbox.checked = false;
					hideSolvedCheckbox.checked = false;

					filterTable();
				}
			}

			function generateRandomIndices(maxValue, count) {
				const randomIndices = [];
				while (randomIndices.length < count) {
					const randomIndex = Math.floor(Math.random() * maxValue);
					if (!randomIndices.includes(randomIndex)) {
						randomIndices.push(randomIndex);
					}
				}
				return randomIndices;
			}

			filterTable();
		};
		var iframeMinimized = false;
		var html = document.querySelector("html");
		var body = document.querySelector("body");

		function toggleProblem() {
			var iframe = document.getElementById("iframeProblem");
			iframeMinimized = !iframeMinimized;

			if (iframeMinimized)
				iframe.style.display = "none";
			else
				iframe.style.display = "block";
		}

		function changeIframeSource(number) {
			var iframe = document.getElementById("iframeProblem");

			if (iframeMinimized) {
				toggleProblem();
			}
			iframe.src = "./BOJ/output/" + number + ".html";
			applyStylesToIframe();
		}
		
		function applyStylesToIframe() {
			var iframe = document.getElementById("iframeProblem");
			var innerDocument = iframe.contentDocument || iframe.contentWindow.document;
			innerDocument.body.style.margin = "0 auto";
			style = innerDocument.querySelector('style');

			style.innerHTML += `td, th
				{ border-color:#909090; background-color:#2d2d2d;
				color:#E0E0E0; font-family:Malgun Gothic; font-size:14px;}\n`

			style.innerHTML += `th {background-color:#777777}\n`

			//수식 표현시 종종 나타나는 찌꺼기 제거
			style.innerHTML += `.mjx-copytext { font-size:0px;}\n`

			//수식 태그 강조
			style.innerHTML += `math { color:yellow;}\n`

			//링크 가독성, 파랑 대신 하늘색
			style.innerHTML += `a { color:aqua;}\n`

			//이미지 사이즈 제한
			style.innerHTML += `img{ max-width:100%;}\n`

			iframe.style.height = '0';
			iframe.style.height = innerDocument.body.scrollHeight+"px";
			iframe.style.border = "0";
		}
		
		window.addEventListener("DOMContentLoaded", function() {
			document.querySelector("#iframeProblem").onload=applyStylesToIframe;
			toggleProblem();
		});

		window.addEventListener("resize", applyStylesToIframe);
	</script>
</body>
</html>

<!---
vscode에는, HTML 문서의 출력 결과를 실시간으로 확인할 수 있는 live preview 기능이 있어요.
별도의 브라우저를 실행하지 않고도, vscode 내부의 탭에서 결과를 확인할 수 있고,
자바스크립트를 이용한 동적인 효과도 확인할 수 있어요.

웹 서핑시 vscode와 크롬 사이를 알트탭으로 오가는 것이 불편하였는데,
자주 사용하는 URL을 HTML 문서의 iframe으로 내장시켜놓고 그걸 미리보기 탭으로 띄워버리면 되겠더라구요.
아쉽게도 미리보기 탭은 하나만 띄울 수 있더라구요. 상단 즐겨찾기를 구현해서 해결할 수도 있겠군요.

( 어떤 사이트는 iframe 으로 불러올 경우에 서버에서 거절해서 아무 것도 안 뜨더라구요.
구글 스프레드시트는 불러올 수 있었는데, 문서의 편집 권한을 누구든지 가능하도록 설정했더니,
iframe으로 불러온 상태에서도 실시간으로 원본 문서를 수정할 수가 있더라구요. 로그인이 필요 없어요! )


HTML 문서가 조금만 달라져도 미리보기에 즉각적으로 반영되는데, 이를 구현하려는 것인지 이벤트가 예민해요.
키보드 감지 방식인지, 미리보기 탭이랑은 아무런 관련없는 문서를 수정하여도 미리보기 탭이 재렌더링되더군요.
이것 때문에 거슬렸던 적은 단 한번도 없어요. 지금에야 알았어요.

그런데, 미리보기 탭이 렌더링 될 때마다 iframe컨텐츠가 새로고침되고 vscode의 포커스를 빼앗기도해요.
아무 상관 없는 문서에 12345 라고 적으려는데, 미리보기 탭의 구글 스프레드시트에 12345가 기입되어버리는 등.
미리보기 탭을 꺼내두기만 하였지, 당장 열어서 보고있는 상태가 아닌데도 포커스를 빼앗아가더군요.
vscode가 크롬 기반이라서 그런지, 하나의 포커스만 가지고 돌려쓰는건지도 모르겠네요.

이럴 때는 <body> 태그에 data-server-no-reload 속성을 추가하면,
미리보기 탭이 실시간으로 재렌더링되지 않게되어서,
렌더링시 새로고침되는 요소에 vscode가 포커스를 빼앗기지 않게되어요.
--->