<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase DB 마이그레이션 (Elaborate1 필드 분리)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px; }
        #log-container { 
            background-color: #f4f4f4; 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Firebase DB 마이그레이션 (Elaborate1 필드 분리)</h1>
    <p>이 도구는 <code>liar_groups</code>의 각 발언(statement)에 대해 다음 작업을 수행합니다:</p>
    <ul>
        <li><code>elaborate1</code> 필드에 'ㅡ' 문자가 있는지 확인합니다.</li>
        <li>'ㅡ' 문자가 있는 경우, 첫 번째 'ㅡ'를 기준으로 문자열을 분리합니다.</li>
        <li>'ㅡ' 앞의 내용은 <code>opening</code> 필드에, 뒤의 내용은 새로운 <code>elaborate1</code> 필드에 저장합니다.</li>
        <li>'ㅡ' 문자가 없는 경우, 해당 발언은 변경되지 않습니다.</li>
    </ul>
    <button id="backup-button">JSON으로 백업</button>
    <button id="migration-button">마이그레이션 시작</button>
    <div id="log-container">진행 상황이 여기에 표시됩니다...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
            authDomain: "liarwords-af033.firebaseapp.com",
            databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
            projectId: "liarwords-af033",
            storageBucket: "liarwords-af033.appspot.com",
            messagingSenderId: "171671976030",
            appId: "1:171671976030:web:59371970ec6b2a70035ccf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logContainer = document.getElementById('log-container');

        function log(message) {
            console.log(message);
            logContainer.innerHTML += message + '';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function backupDatabase() {
            log('백업을 시작합니다...');
            try {
                const snapshot = await get(ref(db));
                const data = snapshot.val();
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `firebase_backup_${new Date().toISOString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                log('백업 파일이 성공적으로 다운로드되었습니다.');
            } catch (error) {
                log('백업 중 오류 발생: ' + error.message);
                console.error(error);
            }
        }

        async function migrateDatabase() {
            log('마이그레이션을 시작합니다...');
            const dbRef = ref(db, 'liar_groups');
            let snapshot;
            try {
                snapshot = await get(dbRef);
            } catch (error) {
                log('데이터를 불러오는 중 오류 발생: ' + error.message);
                return;
            }

            if (!snapshot.exists()) {
                log('liar_groups 데이터가 존재하지 않습니다.');
                return;
            }

            const fullData = snapshot.val();
            let changesMade = 0;
            let changesLog = '변경될 내용 미리보기:';

            for (const groupId in fullData) {
                const group = fullData[groupId];
                if (group.statements && Array.isArray(group.statements)) {
                    group.statements.forEach((stmt, index) => {
                        if (typeof stmt.elaborate1 === 'string' && stmt.elaborate1.includes('ㅡ')) {
                            const original = stmt.elaborate1;
                            const splitIndex = original.indexOf('ㅡ');
                            
                            const newOpening = original.substring(0, splitIndex).trim();
                            const newElaborate1 = original.substring(splitIndex + 1).trim();

                            changesLog += `[Group ${groupId}, Stmt ${index}]`;
                            changesLog += `  기존 opening: "${stmt.opening}"`;
                            changesLog += `  기존 elaborate1: "${original}"`;
                            changesLog += `  --> 새 opening: "${newOpening}"`;
                            changesLog += `  --> 새 elaborate1: "${newElaborate1}"`;

                            // Apply changes to the object that will be saved
                            stmt.opening = newOpening;
                            stmt.elaborate1 = newElaborate1;
                            changesMade++;
                        }
                    });
                }
            }

            if (changesMade === 0) {
                log('변경할 항목이 없습니다. 모든 데이터가 이미 올바른 형식입니다.');
                return;
            }

            log(changesLog);
            
            const userConfirm = confirm(`${changesMade}개의 항목이 변경됩니다. DB에 적용하시겠습니까? 이 작업은 되돌릴 수 없습니다.`);

            if (userConfirm) {
                log('사용자가 변경을 승인했습니다. 데이터베이스에 쓰는 중...');
                try {
                    await set(dbRef, fullData);
                    log('마이그레이션이 성공적으로 완료되었습니다!');
                } catch (error) {
                    log('데이터베이스에 쓰는 중 오류 발생: ' + error.message);
                    console.error(error);
                }
            } else {
                log('사용자가 변경을 취소했습니다. 작업이 중단되었습니다.');
            }
        }
        
        document.getElementById('backup-button').addEventListener('click', backupDatabase);
        document.getElementById('migration-button').addEventListener('click', migrateDatabase);

    </script>
</body>
</html>
