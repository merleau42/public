<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase DB 마이그레이션 도구 (2단계)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px; }
        #log-container { 
            background-color: #f4f4f4; 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Firebase DB 마이그레이션 (2단계)</h1>
    <p>이 도구는 <code>liar_groups</code> 데이터베이스의 구조를 다음과 같이 업데이트합니다:</p>
    <ul>
        <li>각 발언(statement) 객체에 <code>family: 0</code>과 <code>unique: 0</code> 필드를 추가합니다.</li>
        <li><code>statements</code> 필드를 객체에서 **배열**로 변환하여 숫자 인덱싱(0, 1, 2...)이 가능하게 합니다.</li>
    </ul>
    <button id="backup-button" onclick="backupDatabase()">JSON으로 백업</button>
    <button id="migration-button" onclick="migrateDatabaseStep2()">2단계 마이그레이션 시작</button>
    <div id="log-container">진행 상황이 여기에 표시됩니다...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
            authDomain: "liarwords-af033.firebaseapp.com",
            databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
            projectId: "liarwords-af033",
            storageBucket: "liarwords-af033.appspot.com",
            messagingSenderId: "171671976030",
            appId: "1:171671976030:web:59371970ec6b2a70035ccf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logContainer = document.getElementById('log-container');

        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `
[${timestamp}] ${message}`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function backupDatabase() {
            log('백업을 시작합니다...');
            document.getElementById('backup-button').disabled = true;
            try {
                const snapshot = await get(ref(db, 'liar_groups'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date();
                    const timestamp = date.getFullYear().toString() + 
                                    ('0' + (date.getMonth() + 1)).slice(-2) + 
                                    ('0' + date.getDate()).slice(-2) + '_' +
                                    ('0' + date.getHours()).slice(-2) + 
                                    ('0' + date.getMinutes()).slice(-2) +
                                    ('0' + date.getSeconds()).slice(-2);
                    a.download = `liar_groups_backup_step2_${timestamp}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log('✅ 백업 파일이 성공적으로 다운로드되었습니다.');
                } else {
                    log('🔥 백업할 데이터가 없습니다.');
                }
            } catch (error) {
                log('❌ 백업 실패: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('backup-button').disabled = false;
            }
        }

        async function migrateDatabaseStep2() {
            document.getElementById('migration-button').disabled = true;
            log('2단계 마이그레이션을 시작합니다...');

            const groupsRef = ref(db, 'liar_groups');

            try {
                const snapshot = await get(groupsRef);
                if (!snapshot.exists()) {
                    log('🔥 마이그레이션할 데이터가 없습니다.');
                    return;
                }

                const originalData = snapshot.val();
                const migratedData = {};
                let isMigrationNeeded = false;

                for (const groupId in originalData) {
                    const group = originalData[groupId];
                    const newGroup = JSON.parse(JSON.stringify(group));

                    // `statements`가 객체이지만 배열이 아닌 경우에만 변환 진행
                    if (newGroup.statements && typeof newGroup.statements === 'object' && !Array.isArray(newGroup.statements)) {
                        isMigrationNeeded = true;
                        const statementsArray = [];
                        
                        // 객체의 키를 정렬하여 순서를 보장 (s0, s1, s10 ...)
                        const sortedKeys = Object.keys(newGroup.statements).sort((a, b) => {
                            const numA = parseInt(a.substring(1), 10);
                            const numB = parseInt(b.substring(1), 10);
                            return numA - numB;
                        });

                        for (const key of sortedKeys) {
                            const statement = newGroup.statements[key];
                            // 신규 필드 추가
                            statement.family = statement.family !== undefined ? statement.family : 0;
                            statement.unique = statement.unique !== undefined ? statement.unique : 0;
                            statementsArray.push(statement);
                        }
                        newGroup.statements = statementsArray;
                    }
                    
                    migratedData[groupId] = newGroup;
                }

                if (!isMigrationNeeded) {
                    log('✅ 모든 데이터가 이미 2단계 마이그레이션이 적용된 구조입니다.');
                    return;
                }

                log('---------- 새로운 데이터 구조 미리보기 ----------');
                log(JSON.stringify(migratedData, null, 2));
                log('-------------------------------------------');

                const userConfirmation = prompt("위의 구조로 데이터를 마이그레이션하시겠습니까? 데이터베이스를 덮어쓰려면 'yes'를 입력하세요.");

                if (userConfirmation === 'yes') {
                    log('데이터베이스에 쓰는 중...');
                    await set(groupsRef, migratedData);
                    log('✅ 2단계 마이그레이션이 성공적으로 완료되었습니다.');
                } else {
                    log('❌ 사용자가 마이그레이션을 취소했습니다.');
                }

            } catch (error) {
                log('❌ 마이그레이션 중 오류가 발생했습니다: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('migration-button').disabled = false;
            }
        }
        
        window.migrateDatabaseStep2 = migrateDatabaseStep2;
        window.backupDatabase = backupDatabase;
    </script>
</body>
</html>
