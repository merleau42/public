<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ (3ë‹¨ê³„ - íŒŒì‹±)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px; }
        #log-container { 
            background-color: #f4f4f4; 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Firebase DB ë§ˆì´ê·¸ë ˆì´ì…˜ (3ë‹¨ê³„ - íŒŒì‹±)</h1>
    <p>ì´ ë„êµ¬ëŠ” <code>liar_groups</code>ì˜ ê° ë°œì–¸(statement)ì— ëŒ€í•´ ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:</p>
    <ul>
        <li><code>elaborate1</code> í•„ë“œì˜ ë‚´ìš©ì„ ì •ê·œì‹ <code>(^[^:]+):([^ã…¡]+)ã…¡(.+)</code>ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.</li>
        <li>ì„±ê³µ ì‹œ, íŒŒì‹±ëœ ê·¸ë£¹ë“¤ì„ ê°ê° <code>subject</code>, <code>opening</code>, <code>elaborate1</code> í•„ë“œì— ë¶„ë°°í•©ë‹ˆë‹¤.</li>
        <li>ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš°, í•´ë‹¹ ë°œì–¸ì€ ë³€ê²½ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
    </ul>
    <button id="backup-button" onclick="backupDatabase()">JSONìœ¼ë¡œ ë°±ì—…</button>
    <button id="migration-button" onclick="migrateDatabaseStep3()">3ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>
    <div id="log-container">ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
            authDomain: "liarwords-af033.firebaseapp.com",
            databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
            projectId: "liarwords-af033",
            storageBucket: "liarwords-af033.appspot.com",
            messagingSenderId: "171671976030",
            appId: "1:171671976030:web:59371970ec6b2a70035ccf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logContainer = document.getElementById('log-container');

        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `
[${timestamp}] ${message}`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function backupDatabase() {
            log('ë°±ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
            document.getElementById('backup-button').disabled = true;
            try {
                const snapshot = await get(ref(db, 'liar_groups'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date();
                    const timestamp = date.getFullYear().toString() + 
                                    ('0' + (date.getMonth() + 1)).slice(-2) + 
                                    ('0' + date.getDate()).slice(-2) + '_' +
                                    ('0' + date.getHours()).slice(-2) + 
                                    ('0' + date.getMinutes()).slice(-2) +
                                    ('0' + date.getSeconds()).slice(-2);
                    a.download = `liar_groups_backup_step3_${timestamp}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log('âœ… ë°±ì—… íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    log('ğŸ”¥ ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                log('âŒ ë°±ì—… ì‹¤íŒ¨: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('backup-button').disabled = false;
            }
        }

        async function migrateDatabaseStep3() {
            document.getElementById('migration-button').disabled = true;
            log('3ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜ (íŒŒì‹±)ì„ ì‹œì‘í•©ë‹ˆë‹¤...');

            const groupsRef = ref(db, 'liar_groups');
            const regex = /^([^:]+):([^ã…¡]+)ã…¡(.+)/;

            try {
                const snapshot = await get(groupsRef);
                if (!snapshot.exists()) {
                    log('ğŸ”¥ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const originalData = snapshot.val();
                // Deep copy to avoid modifying original data during loop
                const migratedData = JSON.parse(JSON.stringify(originalData));
                let changesMade = 0;

                for (const groupId in migratedData) {
                    const group = migratedData[groupId];

                    if (Array.isArray(group.statements)) {
                        group.statements.forEach(statement => {
                            if (typeof statement.elaborate1 === 'string') {
                                const match = statement.elaborate1.match(regex);
                                
                                if (match) {
                                    // ì •ê·œì‹ ë§¤ì¹­ ì„±ê³µ
                                    statement.subject = match[1].trim();
                                    statement.opening = match[2].trim();
                                    statement.elaborate1 = match[3].trim();
                                    changesMade++;
                                }
                            }
                        });
                    }
                }

                if (changesMade === 0) {
                    log('âœ… íŒŒì‹±í•  ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ëª¨ë“  ë°ì´í„°ê°€ ì´ë¯¸ íŒŒì‹±ëœ êµ¬ì¡°ì…ë‹ˆë‹¤.');
                    return;
                }

                log(`ì´ ${changesMade}ê°œì˜ ë°œì–¸ì´ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                log('---------- ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸° ----------');
                log(JSON.stringify(migratedData, null, 2));
                log('-------------------------------------------');

                const userConfirmation = prompt("ìœ„ì˜ êµ¬ì¡°ë¡œ ë°ì´í„°ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë®ì–´ì“°ë ¤ë©´ 'yes'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

                if (userConfirmation === 'yes') {
                    log('ë°ì´í„°ë² ì´ìŠ¤ì— ì“°ëŠ” ì¤‘...');
                    await set(groupsRef, migratedData);
                    log('âœ… 3ë‹¨ê³„ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    log('âŒ ì‚¬ìš©ìê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                log('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('migration-button').disabled = false;
            }
        }
        
        window.migrateDatabaseStep3 = migrateDatabaseStep3;
        window.backupDatabase = backupDatabase;
    </script>
</body>
</html>
