<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹 데이터 리매핑</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 20px; white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; background-color: #f4f4f4; }
    </style>
</head>
<body>

    <h1>그룹 데이터 리매핑</h1>
    <p>
        이 페이지는 Firebase 데이터베이스의 'groups'에 있는 모든 데이터를 읽어옵니다.<br>
        그리고 각 그룹의 키(ID)를 '0000'부터 시작하는 숫자 형식으로 새로 부여하여, 'liar_groups'라는 새로운 경로에 저장합니다.
    </p>
    <p><strong>주의:</strong> 이 작업은 전체 데이터를 덮어쓰므로 신중하게 실행하십시오.</p>

    <button onclick="runRemapping()">리매핑 실행</button>

    <div id="status">상태: 대기 중...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        // Firebase 앱 초기화 설정
        const app = initializeApp({
            apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
            authDomain: "liarwords-af033.firebaseapp.com",
            databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
            projectId: "liarwords-af033",
            storageBucket: "liarwords-af033.appspot.com",
            messagingSenderId: "171671976030",
            appId: "1:171671976030:web:59371970ec6b2a70035ccf"
        });
        const db = getDatabase(app);
        const statusDiv = document.getElementById('status');

        // 비밀번호를 확인하고 콜백 함수를 실행하는 함수
        async function confirmPasswordAndProceed(permissionKey, callback) {
            if (sessionStorage.getItem(permissionKey) === 'true') {
                callback();
                return;
            }
            const password = prompt("이 작업을 수행하려면 관리자 비밀번호를 입력하세요:");
            if (password === null) {
                statusDiv.textContent = '작업이 취소되었습니다.';
                return;
            }
            try {
                const pwSnapshot = await get(ref(db, 'pw'));
                const storedPassword = pwSnapshot.exists() ? pwSnapshot.val() : null;
                if (password === storedPassword) {
                    sessionStorage.setItem(permissionKey, 'true');
                    callback();
                } else {
                    alert('비밀번호가 틀렸습니다.');
                    statusDiv.textContent = '상태: 비밀번호 오류.';
                }
            } catch (error) {
                alert('비밀번호 확인 중 오류가 발생했습니다.');
                console.error("비밀번호 가져오기 오류:", error);
                statusDiv.textContent = `상태: 오류 발생
${error.message}`;
            }
        }

        // 실제 리매핑 작업을 수행하는 함수
        async function remapAndSave() {
            statusDiv.textContent = '1. "groups" 데이터 읽는 중...';
            const groupsRef = ref(db, 'groups');
            const liarGroupsRef = ref(db, 'liar_groups');

            try {
                const snapshot = await get(groupsRef);
                if (!snapshot.exists()) {
                    statusDiv.textContent = '오류: "groups"에 데이터가 없습니다.';
                    return;
                }

                statusDiv.textContent += `2. 데이터 변환 중...`;
                const groupsData = snapshot.val();
                const remappedGroups = {};
                let counter = 0;

                const sortedKeys = Object.keys(groupsData).sort();

                for (const key of sortedKeys) {
                    const newKey = String(counter).padStart(4, '0');
                    remappedGroups[newKey] = groupsData[key];
                    counter++;
                }

                statusDiv.textContent += `3. 총 ${counter}개의 그룹을 "liar_groups"에 저장하는 중...`;
                
                // 변환된 데이터를 'liar_groups' 경로에 저장
                await set(liarGroupsRef, remappedGroups);

                statusDiv.textContent += `✅ 작업 완료! 성공적으로 데이터를 변환하고 저장했습니다.`;

            } catch (error) {
                console.error('리매핑 작업 중 오류 발생:', error);
                statusDiv.textContent =
                `상태: 오류 발생 ${error.message}.. Firebase 데이터베이스 규칙에서 이 작업을 수행할 권한이 있는지 확인하세요.`;
                alert('작업에 실패했습니다. 콘솔을 확인해주세요.');
            }
        }

        // 버튼 클릭 시 실행될 전역 함수
        window.runRemapping = function() {
            // 실행 전 비밀번호 확인
            confirmPasswordAndProceed('remap_permission', remapAndSave);
        }

    </script>

</body>
</html>
