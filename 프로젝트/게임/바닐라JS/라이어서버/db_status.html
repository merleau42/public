<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB 데이터 개수 확인</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 20px; font-size: 18px; }
        .count-result {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1>데이터베이스 항목 개수 확인</h1>
    <p>
        'groups'와 'liar_groups' 경로에 각각 몇 개의 데이터 항목이 있는지 확인합니다.
    </p>

    <button onclick="runCheck()">개수 확인</button>

    <div id="status">
        <div id="groups-count"><strong>Groups:</strong> -</div>
        <div id="liar-groups-count"><strong>Liar Groups:</strong> -</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        // Firebase 앱 초기화 설정
        const app = initializeApp({
            apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
            authDomain: "liarwords-af033.firebaseapp.com",
            databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
            projectId: "liarwords-af033",
            storageBucket: "liarwords-af033.appspot.com",
            messagingSenderId: "171671976030",
            appId: "1:171671976030:web:59371970ec6b2a70035ccf"
        });
        const db = getDatabase(app);
        const groupsCountDiv = document.getElementById('groups-count');
        const liarGroupsCountDiv = document.getElementById('liar-groups-count');

        // 비밀번호를 확인하고 콜백 함수를 실행하는 함수
        async function confirmPasswordAndProceed(permissionKey, callback) {
            if (sessionStorage.getItem(permissionKey) === 'true') {
                callback();
                return;
            }
            const password = prompt("이 작업을 수행하려면 관리자 비밀번호를 입력하세요:");
            if (password === null) {
                groupsCountDiv.innerHTML = '<strong>Groups:</strong> 작업이 취소되었습니다.';
                liarGroupsCountDiv.innerHTML = '<strong>Liar Groups:</strong> 작업이 취소되었습니다.';
                return;
            }
            try {
                const pwSnapshot = await get(ref(db, 'pw'));
                const storedPassword = pwSnapshot.exists() ? pwSnapshot.val() : null;
                if (password === storedPassword) {
                    sessionStorage.setItem(permissionKey, 'true');
                    callback();
                } else {
                    alert('비밀번호가 틀렸습니다.');
                }
            } catch (error) {
                alert('비밀번호 확인 중 오류가 발생했습니다.');
                console.error("비밀번호 가져오기 오류:", error);
            }
        }

        // 실제 데이터 개수를 확인하는 함수
        async function checkCounts() {
            groupsCountDiv.innerHTML = '<strong>Groups:</strong> 확인 중...';
            liarGroupsCountDiv.innerHTML = '<strong>Liar Groups:</strong> 확인 중...';

            try {
                // 'groups' 개수 확인
                const groupsRef = ref(db, 'groups');
                const groupsSnapshot = await get(groupsRef);
                const groupsCount = groupsSnapshot.exists() ? groupsSnapshot.size : 0;
                groupsCountDiv.innerHTML = `<strong>Groups:</strong> ${groupsCount}개`;

                // 'liar_groups' 개수 확인
                const liarGroupsRef = ref(db, 'liar_groups');
                const liarGroupsSnapshot = await get(liarGroupsRef);
                const liarGroupsCount = liarGroupsSnapshot.exists() ? liarGroupsSnapshot.size : 0;
                liarGroupsCountDiv.innerHTML = `<strong>Liar Groups:</strong> ${liarGroupsCount}개`;

            } catch (error) {
                console.error('데이터 개수 확인 중 오류 발생:', error);
                alert('데이터를 가져오는 데 실패했습니다. 콘솔을 확인해주세요.');
                groupsCountDiv.innerHTML = '<strong>Groups:</strong> 오류 발생';
                liarGroupsCountDiv.innerHTML = '<strong>Liar Groups:</strong> 오류 발생';
            }
        }

        // 버튼 클릭 시 실행될 전역 함수
        window.runCheck = function() {
            confirmPasswordAndProceed('db_check_permission', checkCounts);
        }

    </script>

</body>
</html>
