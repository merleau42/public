<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Firebase 낱말 사전 출력</title>
  <style>
    body {
      margin: 0;
      padding: 2vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    div * {
      font-size: 16px;
    }

    .flex-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    input {
      width: 40vw;
      height: 5vw;
      padding: 8px;
    }

	input, .section {
		border-radius: 10px;
	}

	#div1, #div2, #div3 {
		margin-bottom: 3vh;
	}

    #div2 button {
      width: 20vw;
      padding: 8px;
    }

    #output {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      width: 100%;
      justify-content: center;
      margin: 10px auto 0 auto; /* 가운데 정렬 */
    }

    .section {
      width: 21vw;
      border: 1px solid rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .section h3 {
      margin: 0;
      text-align: center;
      color: powderblue;
    }

    #div3 {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="div1" class="flex-container">
    <input type="text" id="input1">
    <input type="text" id="input2">
    <input type="text" id="input3">
    <input type="text" id="input4">
    <input type="text" id="input5">
    <input type="text" id="input6">
    <input type="text" id="input7">
    <input type="text" id="input8">
  </div>

  <div id="div2" class="flex-container">
    <input type="text" id="singleInput">
    <button onclick="addSingle()">추가</button>
    <button onclick="loadFromDB()">불러오기</button>
  </div>

  <div id="div3">
    <div id="output"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
      authDomain: "liarwords-af033.firebaseapp.com",
      projectId: "liarwords-af033",
      storageBucket: "liarwords-af033.appspot.com",
      messagingSenderId: "171671976030",
      appId: "1:171671976030:web:59371970ec6b2a70035ccf",
      databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.addSingle = function () {
      const val = document.getElementById("singleInput").value.trim();
      if (val) {
        push(ref(db, "strings"), val)
          .then(() => {
            console.log("✅ 저장됨:", val);
            document.getElementById("singleInput").value = '';
          })
          .catch(err => console.error("❌ 저장 실패:", err));
      } else {
        console.log("⚠️ 입력값 없음");
      }
    };

    function getInitialGroupByRange(char) {
      const code = char.charCodeAt(0);
      if (char >= '0' && char <= '9') return '숫자/기타';
      if ((char >= 'a' && char <= 'z') || (char >= 'A' && char <= 'Z')) return '영어';
      if (code < 0xAC00 || code > 0xD7A3) return '숫자/기타';

      const cho = Math.floor((code - 0xAC00) / (21 * 28));
      const choMap = [
        '가','가','나','다','다','라','마','바','바','사',
        '사','아','자','자','차','카','타','파','하'
      ];
      return choMap[cho] || '숫자/기타';
    }

    window.loadFromDB = async function () {
      const output = document.getElementById("output");
      output.innerHTML = "불러오는 중...";
      try {
        const snapshot = await get(ref(db, "strings"));
        output.innerHTML = "";

        const sectionLabels = ['가','나','다','라','마','바','사','아','자','차','카','타','파','하','영어','숫자/기타'];
        const grouped = {};
        sectionLabels.forEach(label => grouped[label] = []);

        if (snapshot.exists()) {
          const data = snapshot.val();
          const groups = Object.values(data).map(str =>
            str.split(',').map(word => word.trim()).filter(Boolean)
          );

          const map = {};
          for (const group of groups) {
            for (const word of group) {
              if (!map[word]) map[word] = new Set();
              for (const peer of group) {
                if (peer !== word) map[word].add(peer);
              }
            }
          }

          const sortedWords = Object.keys(map).sort((a, b) => a.localeCompare(b, 'ko'));

          for (const word of sortedWords) {
            const initial = getInitialGroupByRange(word[0]);
            if (!grouped[initial]) grouped['숫자/기타'].push(word);
            else grouped[initial].push(word);
          }

          sectionLabels.forEach(label => {
            const section = document.createElement('div');
            section.className = 'section';
            const title = document.createElement('h3');
            title.textContent = label;
            section.appendChild(title);

            grouped[label].forEach(word => {
              const peers = Array.from(map[word]).sort((a, b) => a.localeCompare(b, 'ko'));
              const div = document.createElement("div");
              div.textContent = `${word} → ${peers.join(", ")}`;
              section.appendChild(div);
            });

            output.appendChild(section);
          });

        } else {
          output.textContent = "🔥 데이터 없음";
        }
      } catch (err) {
        console.error("❌ 불러오기 실패:", err);
        output.textContent = "❌ 불러오기 실패";
      }
    };
  </script>
</body>
</html>
