<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÎÖºÎ¶¨ ÌçºÏ¶ê ÌîåÎû´Ìèº</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="grid-container" id="grid"></div>
  <div id="debug" align="center">ÎîîÎ≤ÑÍ∑∏</div>

  <script>
    function Elem(tag, cls) {
      const el = document.createElement(tag);
      if (cls) el.className = cls;
      return el;
    }
    function Q(sel) { return document.querySelector(sel); }
    function QQ(sel) { return Array.from(document.querySelectorAll(sel)); }
    function randz(min, max, count = 1, allowDuplicates = true) {
      const result = [];
      while (result.length < count) {
        const num = Math.floor(Math.random() * (max - min + 1)) + min;
        if (allowDuplicates || !result.includes(num)) {
          result.push(num);
        }
      }
      return count === 1 ? result[0] : result;
    }
    function vector(count, fn) {
      return Array.from({ length: count }, (_, i) => fn(i));
    }
    function debug(val) {
      Q('#debug').textContent = val;
    }

    const container = Q('#grid');
    const cards = 12;
    const ÎèôÎ¨º = ['ÏõêÏà≠Ïù¥','Ïó¨Ïö∞','Î∂ÄÏóâÏù¥','Í≥∞','ÌÜ†ÎÅº','ÎèºÏßÄ','Í∞ïÏïÑÏßÄ','Í≥†ÏñëÏù¥','ÌñÑÏä§ÌÑ∞','Ìé≠Í∑Ñ','ÏÇ¨Ïûê','Ìò∏ÎûëÏù¥','ÌåêÎã§','ÎÑàÍµ¨Î¶¨','Îã§ÎûåÏ•ê','ÏñºÎ£©Îßê','Í≥†Ïä¥ÎèÑÏπò','ÏΩîÎÅºÎ¶¨','ÏïÖÏñ¥','Ï∫•Í±∞Î£®'];
    const Î¨¥ÏûëÏúÑ = randz(0, ÎèôÎ¨º.length - 1, cards, false);
    const ÌåªÎßê = ['ÎÖ∏Îßê', 'ÏÜåÏã†Ï¢å', 'ÎùºÍ≤∞Ïûê', 'ÏñëÎ∞ú', 'Í∫æÍ∏∞', 'ÌòºÎûÄÏ¢å', 'Ìè¨Í¥Ñ', 'ÎãµÏùΩÍ∏∞', 'ÎπåÎü∞', '???'];

    const animals = vector(cards, i => ({
      id: i,
      img: Î¨¥ÏûëÏúÑ[i],
      demo: ÌåªÎßê[randz(0, ÌåªÎßê.length - 1)],
      text: ÎèôÎ¨º[Î¨¥ÏûëÏúÑ[i]],
    }));

    const Ïù¥Î™®ÏßÄÏÑ†ÌÉùÏßÄ = ['üö´','‚≠ï','‚ùå','üòà','üî¥','üü†','ü§î','üü°','üü£','üòá','üü¢','üîµ'];
    const Ïù¥Î™®ÏßÄÍ∞ÅÎèÑ = [26, 58, 90];
    const Ïù¥Î™®ÏßÄÎ∞òÏßÄÎ¶ÑÎπÑÏú® = 45;

    function setupEmojiInterface(profileEl) {
      const ÏÉÅÌÉú = { Ïù¥Î™®ÏßÄÎì§: [] };

      const Í∞±Ïã† = () => {
        profileEl.querySelectorAll('.emoji-button').forEach(el => el.remove());

        ÏÉÅÌÉú.Ïù¥Î™®ÏßÄÎì§.forEach((emj, i) => {
          const rad = Math.PI * Ïù¥Î™®ÏßÄÍ∞ÅÎèÑ[i] / 180;
          const btn = Elem('div', 'emoji-button');
          btn.textContent = emj;
          btn.style.left = `${50 + Ïù¥Î™®ÏßÄÎ∞òÏßÄÎ¶ÑÎπÑÏú® * Math.sin(rad)}%`;
          btn.style.top = `${50 - Ïù¥Î™®ÏßÄÎ∞òÏßÄÎ¶ÑÎπÑÏú® * Math.cos(rad)}%`;
          btn.addEventListener('click', e => Ïó¥Í∏∞(i, e));
          profileEl.appendChild(btn);
        });

        if (ÏÉÅÌÉú.Ïù¥Î™®ÏßÄÎì§.length < Ïù¥Î™®ÏßÄÍ∞ÅÎèÑ.length) {
          const i = ÏÉÅÌÉú.Ïù¥Î™®ÏßÄÎì§.length;
          const rad = Math.PI * Ïù¥Î™®ÏßÄÍ∞ÅÎèÑ[i] / 180;
          const plus = Elem('div', 'emoji-button');
          plus.textContent = '‚ûï';
          plus.style.left = `${50 + Ïù¥Î™®ÏßÄÎ∞òÏßÄÎ¶ÑÎπÑÏú® * Math.sin(rad)}%`;
          plus.style.top = `${50 - Ïù¥Î™®ÏßÄÎ∞òÏßÄÎ¶ÑÎπÑÏú® * Math.cos(rad)}%`;
          plus.addEventListener('click', e => Ïó¥Í∏∞(i, e));
          profileEl.appendChild(plus);
        }
      };

      const Ïó¥Í∏∞ = (idx, ev) => {
        ev.stopPropagation();
        QQ('.emoji-picker').forEach(p => p.remove());
        const picker = Elem('div', 'emoji-picker');
        Ïù¥Î™®ÏßÄÏÑ†ÌÉùÏßÄ.forEach(emj => {
          const span = Elem('span');
          span.textContent = emj;
          span.addEventListener('click', e => {
            e.stopPropagation();
            if (emj === 'üö´') ÏÉÅÌÉú.Ïù¥Î™®ÏßÄÎì§.splice(idx, 1);
            else ÏÉÅÌÉú.Ïù¥Î™®ÏßÄÎì§[idx] = emj;
            Í∞±Ïã†();
            picker.remove();
          });
          picker.appendChild(span);
        });
        picker.style.left = ev.clientX + 'px';
        picker.style.top = ev.clientY + 'px';
        document.body.appendChild(picker);
      };

      Í∞±Ïã†();
      profileEl._emojiUpdater = Í∞±Ïã†;
    }

    animals.forEach(animal => {
      const wrapper = Elem('div', 'statement-container');
      const profile = Elem('div', 'profile');
      const circle = Elem('div', 'circle');
      const img = Elem('img');
      img.src = `assets/ÎèôÎ¨º${animal.img}.png`;
      circle.appendChild(img);
      profile.appendChild(circle);

      setupEmojiInterface(profile);

      const placard = Elem('div', 'placard');
      placard.textContent = animal.demo;
      placard.dataset.selected = animal.demo;
      profile.appendChild(placard);

      const bubble = Elem('div', 'bubble');
      bubble.textContent = animal.text;

      wrapper.appendChild(profile);
      wrapper.appendChild(bubble);
      container.appendChild(wrapper);

      placard.addEventListener('click', e => {
        e.stopPropagation();
        QQ('.placard.expanded').forEach(p => {
          p.classList.remove('expanded');
          p.removeAttribute('style');
          p.textContent = p.dataset.selected;
        });

        const rect = placard.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        placard.classList.add('expanded');
        placard.style.left = `${centerX - 125}px`;
        placard.style.top = `${centerY - 30}px`;
        placard.innerHTML = '';

        for (let row = 0; row < 2; row++) {
          const rowDiv = Elem('div', 'choice-row');
          ÌåªÎßê.slice(row * 5, (row + 1) * 5).forEach(text => {
            const span = Elem('span', 'choice');
            span.innerHTML = (text === placard.dataset.selected) ? `<strong>${text}</strong>` : text;
            span.addEventListener('click', e => {
              e.stopPropagation();
              placard.textContent = text;
              placard.dataset.selected = text;
              placard.classList.remove('expanded');
              placard.removeAttribute('style');
            });
            rowDiv.appendChild(span);
          });
          placard.appendChild(rowDiv);
        }
      });
    });

    document.addEventListener('click', () => {
      QQ('.emoji-picker').forEach(p => p.remove());
      QQ('.placard.expanded').forEach(p => {
        p.classList.remove('expanded');
        p.removeAttribute('style');
        p.textContent = p.dataset.selected;
      });
    });

    function getColumnCount() {
      const items = QQ('.statement-container');
      const rowTops = new Set();
      items.forEach(item => rowTops.add(item.offsetTop));
      return Math.round(items.length / rowTops.size);
    }

    function updateLayoutBasedOnColumn() {
      QQ('.reverse').forEach(x => x.classList.remove('reverse'));
      const count = getColumnCount();
      const items = QQ('.statement-container').filter((_, i) => i % 2 === 1);
      if (count === 2) items.forEach(el => el.classList.add('reverse'));
    }

    setInterval(() => {
      const placard = Q('.placard.expanded');
      if (placard) {
        const offset = placard.getBoundingClientRect();
        const shiftX = Math.min(0, offset.left - 10);
        const shiftY = Math.min(0, offset.top - 10);
        const overX = offset.right - window.innerWidth + 10;
        const overY = offset.bottom - window.innerHeight + 10;

        if (shiftX < 0 || overX > 0)
          placard.style.left = `calc(${placard.style.left} - ${shiftX || overX}px)`;
        if (shiftY < 0 || overY > 0)
          placard.style.top = `calc(${placard.style.top} - ${shiftY || overY}px)`;
      }
    }, 500);

    window.addEventListener('resize', () => {
      QQ('.profile').forEach(p => {
        if (p._emojiUpdater) p._emojiUpdater();
      });
      updateLayoutBasedOnColumn();
    });

    updateLayoutBasedOnColumn();
  </script>
</body>
</html>
