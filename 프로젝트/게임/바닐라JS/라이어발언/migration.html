<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Firebase DB 마이그레이션 도구</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #status { margin-top: 20px; white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 100px; background-color: #f9f9f9; }
    button { font-size: 16px; padding: 10px 15px; }
  </style>
</head>
<body>

  <h1>Liar Groups DB 데이터 마이그레이션</h1>
  <p>이 도구는 DB의 모든 'liar_groups' 데이터를 정리합니다.</p>
  <ul>
    <li>'statements' 배열의 각 항목에서 'family' 필드를 찾아 삭제합니다.</li>
    <li>'statements' 배열의 각 항목에서 'respond' 필드를 'respond2'로 이름을 변경(이전)합니다.</li>
  </ul>
  <p><strong>주의: 이 작업은 되돌릴 수 없습니다. 시작하기 전에 DB를 백업했는지 확인하세요.</strong></p>
  
  <button id="start-migration-btn">마이그레이션 시작</button>

  <div id="status">진행 상황이 여기에 표시됩니다...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDVVAx9XRziu8IZ9CLczaG20QEOwyY4uLs",
        authDomain: "liarwords-af033.firebaseapp.com",
        databaseURL: "https://liarwords-af033-default-rtdb.firebaseio.com",
        projectId: "liarwords-af033",
        storageBucket: "liarwords-af033.appspot.com",
        messagingSenderId: "171671976030",
        appId: "1:171671976030:web:59371970ec6b2a70035ccf"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'liar_groups');
    const startBtn = document.getElementById('start-migration-btn');
    const statusEl = document.getElementById('status');

    function log(message) {
      console.log(message);
      statusEl.textContent += message + '';
    }

    async function runMigration() {
      startBtn.disabled = true;
      log('마이그레이션을 시작합니다...');

      try {
        log('1. Firebase에서 현재 데이터를 불러옵니다.');
        const snapshot = await get(dbRef);

        if (!snapshot.exists()) {
          log('오류: 데이터를 찾을 수 없습니다. 작업을 중단합니다.');
          return;
        }

        let data = snapshot.val();
        let changesMade = false;

        log('2. 데이터를 분석하고 수정합니다...');
        for (const groupId in data) {
          const group = data[groupId];
          if (group.statements && Array.isArray(group.statements)) {
            let stmtIndex = 0;
            for (const stmt of group.statements) {
              // 'family' 필드 삭제
              if (stmt.hasOwnProperty('family')) {
                delete stmt.family;
                changesMade = true;
                log(` - [Group: ${groupId}, Stmt: ${stmtIndex}] 'family' 필드를 삭제했습니다.`);
              }
              
              // 'respond'를 'respond2'로 이전
              if (stmt.hasOwnProperty('respond')) {
                stmt.respond2 = stmt.respond;
                delete stmt.respond;
                changesMade = true;
                log(` - [Group: ${groupId}, Stmt: ${stmtIndex}] 'respond' 필드를 'respond2'로 이전했습니다.`);
              }
              stmtIndex++;
            }
          }
        }

        if (changesMade) {
          log('3. 변경 사항을 감지하여 Firebase에 저장합니다...');
          await set(dbRef, data);
          log('4. 성공적으로 모든 변경 사항을 저장했습니다.');
          log('마이그레이션 완료!');
        } else {
          log('수정할 필드(family, respond)가 없습니다. 데이터가 이미 최신 상태입니다.');
          log('마이그레이션 완료!');
        }

      } catch (error) {
        log('치명적인 오류가 발생했습니다: ' + error.message);
        console.error(error);
      } finally {
        startBtn.disabled = false;
      }
    }

    startBtn.addEventListener('click', () => {
        if (confirm('정말로 DB 마이그레이션을 시작하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            statusEl.textContent = ''; // 상태창 초기화
            runMigration();
        }
    });
  </script>

</body>
</html>
