name: Sync Sub Repo

on:
  push:
    branches: [ master ]
    paths:
      - 'í”„ë¡œì íŠ¸/ì›¹/í™•ìž¥í”„ë¡œê·¸ëž¨/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - prefix: 'í”„ë¡œì íŠ¸/ì›¹/í™•ìž¥í”„ë¡œê·¸ëž¨'
            repo: 'github.com/merleau42/extension' # 'github.com' ì¶”ê°€
            branch: 'main'
            paths_glob: 'í”„ë¡œì íŠ¸/ì›¹/í™•ìž¥í”„ë¡œê·¸ëž¨/**'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: changed
        run: |
          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse HEAD^ || true)"
          fi
          CNT=$(git diff --name-only "$BEFORE" "${{ github.sha }}" -- "${{ matrix.target.paths_glob }}" | wc -l | tr -d ' ')
          if [ "${CNT:-0}" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - if: steps.changed.outputs.changed == 'true'
        env:
          LANG: C.UTF-8
          LC_ALL: C.UTF-8
        run: |
          set -euo pipefail
          git config --global core.quotepath false
          git config --global i18n.logOutputEncoding utf-8
          git config --global i18n.commitEncoding utf-8

          TARGET_URL="https://${{ secrets.AUTO_TREE }}@${{ matrix.target.repo }}.git"

          echo "Probing remote with ls-remote..."
          git ls-remote "$TARGET_URL" || {
            echo "ðŸš¨ ERROR: Token is invalid or lacks access to the remote repository. Please check your token and repository name."
            exit 1
          }

          # ê¸°ì¡´ ACTION ë¸Œëžœì¹˜ê°€ ìžˆìœ¼ë©´ ì‚­ì œ í›„ ë‹¤ì‹œ ìƒì„± (idempotent)
          git branch -D ACTION 2>/dev/null || true

          SHA=$(git subtree split --prefix="${{ matrix.target.prefix }}" -b ACTION)
          echo "subtree split commit: $SHA"

          echo "Pushing..."
          git push "$TARGET_URL" ACTION:${{ matrix.target.branch }} --force