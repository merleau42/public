name: Sync Sub Repo

on:
  push:
    branches: [ master ]
    paths:
      - '프로젝트/웹/확장프로그램/**'   # 이 경로에 변경이 있을 때만 실행

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - prefix: '프로젝트/웹/확장프로그램'  # 메인 리포에서 분리할 폴더
            repo: 'merleau42/extension'        # owner/repo (도메인/ .git 넣지 않음)
            branch: 'main'                      # 타겟 리포 브랜치
            paths_glob: '프로젝트/웹/확장프로그램/**'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # subtree split에는 전체 히스토리가 필요

      - name: Detect changes for this target
        id: changed
        run: |
          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse HEAD^ || true)"
          fi

          CNT=$(git diff --name-only "$BEFORE" "${{ github.sha }}" -- "${{ matrix.target.paths_glob }}" | wc -l | tr -d ' ')
          if [ "${CNT:-0}" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Subtree split & push
        if: steps.changed.outputs.changed == 'true'   # 항상 실행하려면 이 줄을 지우세요
        env:
          LANG: C.UTF-8
          LC_ALL: C.UTF-8
        run: |
          set -euo pipefail

          # Git이 비-ASCII 경로를 이스케이프하지 않도록 설정
          git config --global core.quotepath false
          git config --global i18n.logOutputEncoding utf-8
          git config --global i18n.commitEncoding utf-8

          # 대상 URL (x-access-token 접두사 사용 / .git 뒤 슬래시 금지)
          TARGET_REPO="${{ matrix.target.repo }}"   # 예: merleau42/extension
          TARGET_URL="https://x-access-token:${{ secrets.AUTO_TREE }}@github.com/${TARGET_REPO}.git"

          echo "::group::Probe remote"
          git ls-remote "$TARGET_URL"
          echo "::endgroup::"

          # 기존 ACTION 브랜치를 정리 후 split
          git branch -D ACTION 2>/dev/null || true
          SHA=$(git subtree split --prefix="${{ matrix.target.prefix }}" -b ACTION)
          echo "subtree split commit: $SHA"
          git log -1 --oneline ACTION || true

          echo "Pushing to ${TARGET_REPO} -> ${{ matrix.target.branch }}"
          git push "$TARGET_URL" ACTION:${{ matrix.target.branch }} --force
