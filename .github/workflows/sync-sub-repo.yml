name: Sync Sub Repos

on:
  push:
    branches: [ master ]
    paths:
      - '프로젝트/확장프로그램/**'
      - '프로젝트/홈페이지/github.io/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
        # 키생성: ssh-keygen -t ed25519 -C "AUTO_TREE" -f ~/.ssh/auto_tree_별명
        # 키확인: cat ~/.ssh/auto_tree_gio*
        # 개인키: 메인 저장소 ㅡ 설정 ㅡ Security ㅡ Actions secrets and variables
        # 공개키: 서브 저장소 ㅡ 설정 ㅡ Security ㅡ Deploy Keys
          - name: extension
            prefix: '프로젝트/확장프로그램'
            ssh_repo: 'git@github.com:merleau42/extension.git'
            branch: 'main'
            paths_glob: '프로젝트/확장프로그램/**'
            deploy_key_secret: 'AUTO_TREE_EXTENSION'

          - name: github_io
            prefix: '프로젝트/홈페이지/github.io'
            ssh_repo: 'git@github.com:merleau42/public.git'
            branch: 'main'
            paths_glob: '프로젝트/홈페이지/github.io/**'
            deploy_key_secret: 'AUTO_TREE_GIO'

          - name: busut
            prefix: '프로젝트/미분류/busut'
            ssh_repo: 'busut777@busut.cafe24app.com:busut777_busut'
            branch: 'master'
            paths_glob: '프로젝트/미분류/busut/**'
            deploy_key_secret: 'AUTO_TREE_BUSUT'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # subtree split에는 전체 히스토리가 필요

      - name: Detect changes for this target
        id: changed
        run: |
          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse HEAD^ || true)"
          fi
          CNT=$(git diff --name-only "$BEFORE" "${{ github.sha }}" -- "${{ matrix.target.paths_glob }}" | wc -l | tr -d ' ')
          if [ "${CNT:-0}" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Subtree split & push (SSH)
        if: steps.changed.outputs.changed == 'true'   # 변경이 있을 때만 실행
        env:
          LANG: C.UTF-8
          LC_ALL: C.UTF-8
          DEPLOY_KEY: ${{ secrets[matrix.target.deploy_key_secret] }}
        run: |
          set -euo pipefail

          # SSH 준비 (deploy key 설치)
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts

          # Git이 비-ASCII 경로를 이스케이프하지 않도록 설정
          git config --global core.quotepath false
          git config --global i18n.logOutputEncoding utf-8
          git config --global i18n.commitEncoding utf-8

          # subtree split
          git branch -D ACTION 2>/dev/null || true
          SHA=$(git subtree split --prefix="${{ matrix.target.prefix }}" -b ACTION)
          echo "subtree split commit: $SHA"
          git log -1 --oneline ACTION || true

          # SSH로 푸시
          echo "Pushing to ${{ matrix.target.ssh_repo }} -> ${{ matrix.target.branch }}"
          git push "${{ matrix.target.ssh_repo }}" ACTION:${{ matrix.target.branch }} --force
