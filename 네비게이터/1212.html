<!DOCTYPE html>
<html>
<head>
	<title>CSV 데이터를 HTML 표로 불러오기</title>
	<style>
		th {
			cursor: pointer;
			text-align: center;
		}

		th.sorted-asc::after {
			content: " ▲";
			color: red;
		}

		th.sorted-desc::after {
			content: " ▼";
			color: red;
		}

		th, td {
			border: 1px solid #000;
			min-width: 53px;
		}

		table {
			border-collapse: collapse;
			border: 1px solid #000;
			width: 95%;
			margin: 0 auto; /* 가운데 정렬 */
		}

		.dropdown-container {
			display: flex;
			align-items: center;
			margin-bottom: 4px;
		}
	</style>
		
</head>
<body data-server-no-reload>
	<div class="dropdown-container">
		<span>태그　</span>
		<select id="includeTagDropdown1">
			<option value="">포함</option>
		</select>
		<select id="includeTagDropdown2">
			<option value="">포함</option>
		</select>
		<select id="excludeTagDropdown1">
			<option value="">미포함</option>
		</select>
		<select id="excludeTagDropdown2">
			<option value="">미포함</option>
		</select>
	</div>
	<div class="dropdown-container">
		<span>티어　</span>
		<select id="tierAboveDropdown">
			<option value="">이상</option>
		</select>
		<select id="tierBelowDropdown">
			<option value="">이하</option>
		</select>
		<span>새로 고침:</span>
		<select id="refreshDropdown">
			<option value="선택">선택</option>
			<option value="조건대로">조건대로</option>
			<option value="랜덤디펜스">랜덤디펜스</option>
			<option value="초기화">초기화</option>
		</select>
	</div>
	<table id="csvTable">
		<thead>
		</thead>
		<tbody>
		</tbody>
	</table>
	<iframe id="csvIframe" style="display: none;" src="./BOJ/백준리스트2"></iframe>
	<script>
		const iframe = document.getElementById("csvIframe");
		iframe.addEventListener("load", once);
		function once() {
			iframe.removeEventListener("load", once);
			const csvData = iframe.contentDocument.body.textContent;
			const table = document.getElementById("csvTable");
			const includeTagDropdown1 = document.getElementById("includeTagDropdown1");
			const includeTagDropdown2 = document.getElementById("includeTagDropdown2");
			const excludeTagDropdown1 = document.getElementById("excludeTagDropdown1");
			const excludeTagDropdown2 = document.getElementById("excludeTagDropdown2");
			const tierAboveDropdown = document.getElementById("tierAboveDropdown");
			const tierBelowDropdown = document.getElementById("tierBelowDropdown");
			const refreshDropdown = document.getElementById("refreshDropdown");
			
			const tiers='브실골플다루';
			const tiersColor=["brown","silver","gold","lime","blue","red"];
			// 티어 이상 및 이하 드롭다운에 1부터 30까지의 자연수를 반복문으로 추가
			for (let i = 1; i <= 30; i++) {
				const optionAbove = document.createElement("option");
				optionAbove.value = i.toString();
				optionAbove.textContent = tiers[Math.floor((i-1)/5)]+(5-(i-1)%5+"");
				tierAboveDropdown.appendChild(optionAbove);

				const optionBelow = document.createElement("option");
				optionBelow.value = i.toString();
				optionBelow.textContent = tiers[Math.floor((i-1)/5)]+(5-(i-1)%5+"");
				tierBelowDropdown.appendChild(optionBelow);
			}

			// 드롭다운 옵션 채우기
			const uniqueTags = [...new Set(csvData.split("\n").map(row => row.split(",")[2].split('/')).flat())];
			uniqueTags.forEach(tag => {
				const option = document.createElement("option");
				option.value = tag;
				option.textContent = tag;
				includeTagDropdown1.appendChild(option);
				includeTagDropdown2.appendChild(option.cloneNode(true));
				excludeTagDropdown1.appendChild(option.cloneNode(true));
				excludeTagDropdown2.appendChild(option.cloneNode(true));
			});

			// 머리글 행 생성
			const headerRow = document.createElement("tr");
			const headers = csvData.split("\n")[0].split(",");
			headers.forEach(headerText => {
				const th = document.createElement("th");
				th.textContent = headerText;
				th.addEventListener("click", () => sortTable(headers.indexOf(headerText)));
				headerRow.appendChild(th);
			});
			table.querySelector("thead").appendChild(headerRow);
			
			// 나머지 줄을 테이블 본문에 추가
			csvData.split("\n").slice(1).forEach(row => {
				const rowData = row.split(",");
				if (rowData.length > 1) {
					const newRow = document.createElement("tr");
					for (let j = 0; j < rowData.length; j++) {
						const cellValue = rowData[j];
						const cell = createCell(cellValue, j);
						newRow.appendChild(cell);
					}
					table.querySelector("tbody").appendChild(newRow);
				}
			});

			function createCell(value, columnIndex) {
				const td = document.createElement("td");
				if (columnIndex === 3){
					td.textContent = parseInt(value);
					td.style.color = tiersColor[Math.floor((parseInt(value)-1)/5)];
				}
				else if (columnIndex === 7){
					//sadsadsadsadsadasdsa
				}
				else
					td.textContent = value
				return td;
			};

			let sortingColumn = -1;
			let ascending = true;
			
			function sortTable(columnIndex) {
				const tbody = table.querySelector("tbody");
				const rows = Array.from(tbody.rows);

				if (sortingColumn === columnIndex) {
					ascending = !ascending;
				} else {
					ascending = true;
					sortingColumn = columnIndex;
				}

				// 머리글 셀에 정렬 아이콘을 추가
				const th = table.querySelector("thead").querySelectorAll("th");
				th.forEach((header, index) => {
					header.classList.remove("sorted-asc", "sorted-desc");
					if (index === columnIndex)
						header.classList.add(ascending ? "sorted-asc" : "sorted-desc");
				});

				rows.sort((a, b) => {
					var cellA = a.cells[columnIndex].textContent.trim();
					var cellB = b.cells[columnIndex].textContent.trim();
					
					if (ascending)
						return cellA.localeCompare(cellB, undefined, { numeric: true, sensitivity: 'base' });
					else
						return cellB.localeCompare(cellA, undefined, { numeric: true, sensitivity: 'base' });
				});
				// 행을 정렬된 순서로 다시 삽입
				for (const row of rows) {
					tbody.appendChild(row);
				}
			}

			// 드롭다운 변경 시 필터링 적용
			includeTagDropdown1.addEventListener("change", () => filterTable());
			includeTagDropdown2.addEventListener("change", () => filterTable());
			excludeTagDropdown1.addEventListener("change", () => filterTable());
			excludeTagDropdown2.addEventListener("change", () => filterTable());
			tierAboveDropdown.addEventListener("change", () => filterTable());
			tierBelowDropdown.addEventListener("change", () => filterTable());
			refreshDropdown.addEventListener("change", () => {
				refreshTable();
				refreshDropdown.selectedIndex = 0; // 기본 옵션으로 리셋
			});
			
			function filterTable() {
				const selectedIncludeTag1 = includeTagDropdown1.value;
				const selectedIncludeTag2 = includeTagDropdown2.value;
				const selectedExcludeTag1 = excludeTagDropdown1.value;
				const selectedExcludeTag2 = excludeTagDropdown2.value;
				const selectedTierAbove = tierAboveDropdown.value;
				const selectedTierBelow = tierBelowDropdown.value;
				
				const tbody = table.querySelector("tbody");
				const rows = Array.from(tbody.rows);

				rows.forEach(row => {
					const rowData = row.cells[2].textContent;
					const tierData = parseInt(row.cells[3].textContent);
					const tags = rowData.split('/');
					const includeTag1Match = !selectedIncludeTag1 || tags.includes(selectedIncludeTag1);
					const includeTag2Match = !selectedIncludeTag2 || tags.includes(selectedIncludeTag2);
					const excludeTag1Match = !selectedExcludeTag1 || !tags.includes(selectedExcludeTag1);
					const excludeTag2Match = !selectedExcludeTag2 || !tags.includes(selectedExcludeTag2);
					const tierMatch = (!selectedTierAbove || tierData >= parseInt(selectedTierAbove)) && (!selectedTierBelow || tierData <= parseInt(selectedTierBelow));

					const showRow = includeTag1Match && includeTag2Match && excludeTag1Match && excludeTag2Match && tierMatch;
					row.style.display = showRow ? "table-row" : "none";
				});
			}

			function refreshTable() {
				// 새로 고침 드롭다운에서 선택된 옵션을 확인
				const refreshOption = refreshDropdown.value;

				if (refreshOption === "조건대로") {
					// 조건에 따라 필터링
					filterTable();
				} else if (refreshOption === "랜덤디펜스") {
					// 랜덤 필터링 예제: 필터된 데이터 중에서 랜덤으로 3개 표시
					filterTable();
					const filteredRows = Array.from(table.querySelector("tbody").rows).filter(row => row.style.display === "table-row");
					const randomIndices = generateRandomIndices(filteredRows.length, 3);
					filteredRows.forEach((row, index) => {
						row.style.display = randomIndices.includes(index) ? "table-row" : "none";
					});
				} else if (refreshOption === "초기화") {
					// 모든 행을 초기화
					Array.from(table.querySelector("tbody").rows).forEach(row => {
						row.style.display = "table-row";
					});

					// 모든 드롭다운을 '선택'으로 리셋
					includeTagDropdown1.selectedIndex = 0;
					includeTagDropdown2.selectedIndex = 0;
					excludeTagDropdown1.selectedIndex = 0;
					excludeTagDropdown2.selectedIndex = 0;
					tierAboveDropdown.selectedIndex = 0;
					tierBelowDropdown.selectedIndex = 0;
					refreshDropdown.selectedIndex = 0;
				}
			}

			function generateRandomIndices(maxValue, count) {
				const randomIndices = [];
				while (randomIndices.length < count) {
					const randomIndex = Math.floor(Math.random() * maxValue);
					if (!randomIndices.includes(randomIndex)) {
						randomIndices.push(randomIndex);
					}
				}
				return randomIndices;
			}
		};
	</script>
</body>
</html>
